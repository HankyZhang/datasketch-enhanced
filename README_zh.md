<div align="center">

# HNSW + K-Means / å¤š Pivot æ··åˆåŒé˜¶æ®µæ£€ç´¢ç³»ç»Ÿï¼ˆä¸­æ–‡ç‰ˆï¼‰

ğŸš€ ä¸€ä¸ªæ¨¡å—åŒ–çš„å®éªŒå¹³å°ï¼šåœ¨çº¯ Python HNSW å®ç°ä¹‹ä¸Šï¼Œå¯¹å¤šç§â€œçˆ¶èŠ‚ç‚¹é€‰æ‹© + ä¸¤é˜¶æ®µæ£€ç´¢â€ç­–ç•¥è¿›è¡Œæ„å»ºã€å¯¹æ¯”ä¸è°ƒä¼˜ã€‚

[English Version](README.md)

</div>

---

## 0. å¿«é€Ÿæ¦‚è§ˆï¼ˆTL;DRï¼‰

| ç»„ä»¶ | ä½œç”¨ | ä»·å€¼ |
|------|------|------|
| `hnsw.HNSW` | æ ¸å¿ƒ HNSW å›¾ç´¢å¼• | åŸºçº¿ ANN æœç´¢ |
| `hybrid_hnsw.HNSWHybrid` | ç›´æ¥ä½¿ç”¨æŸä¸€ HNSW å±‚çº§ä½œä¸ºçˆ¶å±‚ | å¤ç”¨å±‚çº§ç»“æ„ï¼Œé›¶èšç±»æˆæœ¬ |
| `method3` (KMeans + HNSW) | ç”¨ K-Means è´¨å¿ƒå½“çˆ¶èŠ‚ç‚¹ï¼Œå†ç”¨ HNSW å¡«å……å­©å­ | èšç±»æ›´å‡è¡¡ï¼Œå¬å›æ½œåŠ›é«˜ |
| å¤š Pivot ç­–ç•¥ | ä¸€ä¸ªè´¨å¿ƒæ‰©å±•å‡ºå¤šä¸ªä»£è¡¨ç‚¹è¿›è¡Œæ‰“åˆ† | å¢åŠ å€™é€‰å¤šæ ·æ€§ï¼Œæ”¹å–„è¦†ç›– |
| `tune_kmeans_hnsw_optimized.py` | ç»Ÿä¸€è¯„ä¼°è„šæœ¬ï¼ˆsingle/multi/hybrid/baselineï¼‰ | ç½‘æ ¼æ‰«æ+æŒ‡æ ‡è¾“å‡º |

---

## 1. åŠ¨æœº

ä¸¤é˜¶æ®µ ANNï¼ˆç²—å¬å› + ç²¾æ’ï¼‰ç›¸æ¯”å•å±‚æˆ–å¹³é¢ç»“æ„èƒ½åœ¨ä¿æŒé«˜å¬å›çš„åŒæ—¶é™ä½æœç´¢æˆæœ¬ã€‚æœ¬ä»“åº“æŠŠä¸åŒâ€œçˆ¶èŠ‚ç‚¹é€‰æ‹©â€æ–¹å¼ï¼ˆHNSW å±‚çº§ã€K-Means èšç±»ã€å¤š Pivotã€æ··åˆå±‚çº§ fanoutï¼‰ç»Ÿä¸€æˆç­–ç•¥æ¥å£ï¼Œæ–¹ä¾¿å…¬å¹³æ¯”è¾ƒï¼š

æ ¸å¿ƒé—®é¢˜ï¼š
1. èšç±»ï¼ˆK-Meansï¼‰ vs ç»“æ„å±‚çº§ï¼ˆHNSW Levelï¼‰ è°çš„çˆ¶é›†åˆæ›´æœ‰æ•ˆï¼Ÿ
2. å¤š Pivot æ˜¯å¦æ˜¾è‘—æå‡å¬å› / æ—¶é—´çš„å¸•ç´¯æ‰˜è¡¨ç°ï¼Ÿ
3. é‡å¤åˆ†é…ï¼ˆduplicationï¼‰ä¸è¦†ç›–ç‡ï¼ˆcoverageï¼‰å’Œå¬å›çš„ç›¸å…³æ€§ï¼Ÿ
4. fanout / k_children ä½•æ—¶å¢å¤§å·²ç»æ”¶ç›Šé€’å‡ï¼Ÿ

---

## 2. æ¶æ„æ¦‚è§ˆ

```
          +--------------------+
          |   Base HNSW Graph  |
          +--------------------+
                    |
        (Parent Selection Strategy)
          |   |            |
          |   |            +--> Hybrid (level parents)
          |   +------------+--> KMeans (centroid parents)
          +----------------+--> Multi-Pivot (centroid + extra pivots)
                    |
           Parent â†’ Child Assignments
                    |
               TwoStageIndex
                    |
            Query (å‘é‡) è¿›å…¥
                    |
          1) ç²—é˜¶æ®µï¼šè®¡ç®—åˆ°æ‰€æœ‰çˆ¶çš„è·ç¦»
          2) é€‰å‰ n_probe ä¸ªçˆ¶
          3) åˆå¹¶å…¶å­©å­é›†åˆ
          4) ç²¾æ’è¿”å› Top-k
```

åˆ†å±‚æŠ½è±¡ï¼š
1. SharedContextï¼šæå–èŠ‚ç‚¹å‘é‡ + å¯é€‰ä¸€æ¬¡æ€§ K-Meansã€‚
2. Strategyï¼š`prepare(shared)`ï¼ˆå…¨å±€é¢„å¤„ç†ï¼Œå¯é€‰ï¼‰ + `assign_children`ï¼ˆé€çˆ¶æˆªæ–­ï¼‰ã€‚
3. TwoStageIndexï¼šç»Ÿä¸€æ„å»ºï¼ˆå¾ªç¯çˆ¶èŠ‚ç‚¹ â†’ åˆ†é…å­©å­ â†’ å¯é€‰ä¿®å¤ï¼‰+ ç»Ÿä¸€æ£€ç´¢ï¼ˆçˆ¶ç­›é€‰â†’å€™é€‰é›†åˆâ†’ç²¾æ’ï¼‰ã€‚
4. Evaluatorï¼šçœŸå€¼æ„é€  + å¬å›/æ—¶é—´ç»Ÿè®¡ + ç›¸å…³æ€§åˆ†æã€‚

---

## 3. ç­–ç•¥ç»†èŠ‚

| ç­–ç•¥ | çˆ¶é›†åˆæ¥æº | å­é›†åˆæ¥æº | è¯´æ˜ |
|------|------------|------------|------|
| SinglePivot | K-Means è´¨å¿ƒ | èšç±»æˆå‘˜ï¼ˆæˆªæ–­ï¼‰ | æœ€ç®€å•ã€ç¨³å®š |
| MultiPivot | è´¨å¿ƒ + è¿œç‚¹ + å‚ç›´ç‚¹ + max-min | HNSW è¿‘é‚»å€™é€‰åå†æ‰“åˆ† | æå‡å¤šæ ·æ€§ |
| Hybridï¼ˆå±‚çº§ï¼‰ | æŒ‡å®š HNSW å±‚ L æ‰€æœ‰èŠ‚ç‚¹ | æ¯ä¸ªçˆ¶åš fanout æŸ¥è¯¢ | ä¸é‡‡æ ·ï¼Œå±‚ç¼ºå¤±æŠ¥é”™ |
| Baseline HNSW | æ—  | ç›´æ¥ HNSW query | ä¸Šç•Œ/å¯¹ç…§ |

Hybrid ç‰¹æ€§ï¼š
- ä¸¥æ ¼ä½¿ç”¨æŒ‡å®šå±‚çº§ï¼ˆæ— å›é€€ï¼‰ï¼Œ`fanout` æ§åˆ¶æ¯ä¸ªçˆ¶æ”¶é›†çš„å­©å­æ•°é‡ã€‚
- ef æœªæŒ‡å®šæ—¶ï¼š`ef = max(fanout+10, 1.5*fanout)`ã€‚

MultiPivot æµç¨‹ï¼š
1. åˆå§‹ pivot = è´¨å¿ƒã€‚
2. åŠ å…¥æœ€è¿œç‚¹ã€‚
3. å°è¯•é€‰æ‹©â€œå‚ç›´â€ç‚¹ï¼ˆæœ€å¤§å‚è·ï¼‰ã€‚
4. å‰©ä½™ç”¨ max-min è¿­ä»£è¡¥æ»¡ã€‚
5. å€™é€‰æŒ‰ä¸æ‰€æœ‰ pivot çš„æœ€å°è·ç¦»æ’åºæˆªæ–­ã€‚

---

## 4. æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | è®¡ç®—æ–¹å¼ |
|------|------|----------|
| recall_at_k | æ€»ä½“å¬å› | (æ‰€æœ‰å‘½ä¸­æ•°)/(æŸ¥è¯¢æ•°*k) |
| avg_individual_recall | å¹³å‡å•æŸ¥è¯¢å¬å› | æ¯ä¸ªæŸ¥è¯¢å‘½ä¸­ç‡å–å‡å€¼ |
| duplication_rate | é‡å¤åˆ†é…ç‡ | é‡å¤å­©å­æ•° / å…¨éƒ¨åˆ†é…æ¬¡æ•° |
| coverage_fraction | è¦†ç›–ç‡ | å”¯ä¸€è¢«è¦†ç›–å­©å­æ•° / èŠ‚ç‚¹æ€»æ•° |
| avg_query_time_ms | å¹³å‡æŸ¥è¯¢è€—æ—¶ | search è®¡æ—¶å‡å€¼ |
| best_recall | ç½‘æ ¼æœ€ä¼˜å¬å› | ä» sweep é‡Œå–æœ€å¤§ |

è„šæœ¬è¿˜ç»™å‡º duplication / coverage ä¸ best_recall çš„ Pearson ç›¸å…³ç³»æ•°ã€‚

---

## 5. ç»Ÿä¸€è¯„ä¼°è„šæœ¬

æ–‡ä»¶ï¼š`method3/tune_kmeans_hnsw_optimized.py`

åŠŸèƒ½ï¼š
* åˆæˆæ•°æ®ç”Ÿæˆ
* æ„é€  SharedContextï¼ˆä¸€æ¬¡ K-Meansï¼‰
* ç­–ç•¥æšä¸¾ï¼ˆ`--strategy single|multi|hybrid|all`ï¼‰
* `k` ä¸ `n_probe` ç½‘æ ¼æ‰«æ
* åŸºçº¿ HNSW è¯„ä¼°ï¼ˆ`--baseline-ef`ï¼‰
* å¯¼å‡º JSON + ä¸¤ä¸ª CSV
* ç›¸å…³æ€§åˆ†æ

ç¤ºä¾‹ï¼š
```bash
python method3/tune_kmeans_hnsw_optimized.py \
  --dataset-size 20000 \
  --query-size 100 \
  --dimension 128 \
  --n-clusters 64 \
  --k-children 400 \
  --strategy all \
  --k-list 10,20 \
  --n-probe-list 4,8,12 \
  --baseline-ef 400 \
  --out exp.json
```

è¾“å‡ºï¼š
* `exp.json` å…¨é‡ç»“æ„åŒ–ç»“æœ
* `exp_evaluations.csv` æ¯ (method,k,n_probe) æŒ‡æ ‡
* `exp_methods_summary.csv` æ¯æ–¹æ³•æ‘˜è¦

---

## 6. å‚æ•°å‚è€ƒ

| å‚æ•° | é€‚ç”¨ | æè¿° | å¸¸è§èŒƒå›´ |
|------|------|------|----------|
| `--n-clusters` | single/multi | K-Means è´¨å¿ƒæ•° | 16â€“1024 |
| `--k-children` | æ‰€æœ‰ç­–ç•¥ | æ¯çˆ¶ä¿ç•™å­èŠ‚ç‚¹ä¸Šé™ | 100â€“2000 |
| `--num-pivots` | multi | Pivot æ•°é‡ | 2â€“5 |
| `--pivot-strategy` | multi | ç¬¬ä¸‰ä¸ª pivot ç­–ç•¥ | line_perp_third / max_min_distance |
| `--hybrid-fanout` | hybrid | æ¯çˆ¶æŸ¥è¯¢å­©å­æ•°é‡ | 32â€“512 |
| `--baseline-ef` | baseline | åŸºçº¿ HNSW ef | 100â€“2000 |
| `--k-list` | è¯„ä¼° | å¬å› k å€¼åˆ—è¡¨ | 10,20,50 |
| `--n-probe-list` | è¯„ä¼° | æŸ¥è¯¢æ—¶æ¢æµ‹çˆ¶æ•°é‡ | 4â€“64 |
| `--repair-min` | all | å¼ºåˆ¶æœ€å°‘åˆ†é…æ¬¡æ•° | 1â€“3 |

è°ƒä¼˜æç¤ºï¼š
- ä½å¬å›ä¼˜å…ˆå¢å¤§ `n_probe`ï¼›
- è¦†ç›–ç‡ä½ä¸”é‡å¤ç‡ä¸é«˜ â†’ å¢å¤§ `k_children` / `fanout`ï¼›
- é‡å¤ç‡é«˜è€Œå¬å›æå‡åœæ» â†’ å°è¯• multi-pivotï¼›
- é«˜å»¶è¿Ÿ â†’ å‡å° `n_probe * k_children` ä¹˜ç§¯ã€‚

---

## 7. æ•°æ®æµæ­¥éª¤

1. ä» HNSW æå–æ‰€æœ‰ç‚¹å‘é‡ã€‚
2. K-Meansï¼ˆå¦‚ä½¿ç”¨ï¼‰ç”Ÿæˆè´¨å¿ƒ/èšç±»æˆå‘˜ã€‚
3. Strategy å¯åœ¨ `prepare` é˜¶æ®µæ”¹å†™ centroidsï¼ˆå¦‚ Hybridï¼‰æˆ–é¢„å…ˆæŸ¥è¯¢å­©å­ã€‚
4. æ„å»ºï¼šé€çˆ¶æ‰§è¡Œ `assign_children` â†’ å½¢æˆ parent_child æ˜ å°„ã€‚
5. æŸ¥è¯¢ï¼šè®¡ç®— queryâ†’centroid è·ç¦» â†’ é€‰ top n_probe â†’ åˆå¹¶å­©å­é›†åˆå»é‡ â†’ ç²¾æ’ã€‚
6. è¯„ä¼°ï¼šä¸çœŸå€¼æ¯”å¯¹ â†’ ç»Ÿè®¡æŒ‡æ ‡ã€‚

---

## 8. æ‰©å±•æ–°ç­–ç•¥

```python
class MyStrategy(BaseAssignmentStrategy):
    name = "my_strategy"
    def prepare(self, shared):
        # å¯é€‰ï¼šå…¨å±€é¢„å¤„ç†
        ...
    def assign_children(self, cluster_id, centroid_vec, shared, k_children, child_search_ef):
        return [...]
```
æ³¨å†Œï¼šåœ¨è¯„ä¼°è„šæœ¬ä¸­ append åˆ° strategies åˆ—è¡¨å³å¯ã€‚

åˆ›æ„å»ºè®®ï¼š
- åŸºäºå±€éƒ¨å¯†åº¦è‡ªé€‚åº” k_children
- åŸºäºèŠ‚ç‚¹åº¦æ•°/ä¸­å¿ƒæ€§é‡æ–°åˆ†é…
- è½»é‡å­¦ä¹ è·¯ç”±ï¼ˆMLP é¢„æµ‹çˆ¶é›†åˆï¼‰

---

## 9. å¸¸è§é—®é¢˜æ’æŸ¥

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³ |
|------|----------|------|
| Hybrid æŠ¥ ValueError | æŒ‡å®šå±‚çº§ä¸å­˜åœ¨æˆ–ä¸ºç©º | æ¢å±‚çº§æˆ–é‡å»º HNSWï¼ˆåŠ æ·±å±‚ï¼‰ |
| å¬å›å¾ˆä½ | n_probe å¤ªå° / k_children å¤ªå° | å…ˆå¢å¤§ n_probeï¼Œå†è°ƒ k_children |
| å»¶è¿Ÿè¿‡é«˜ | å€™é€‰é›†åˆè¿‡å¤§ | é™ä½ n_probe æˆ– k_children |
| è¦†ç›–ç‡ä½ | fanout / k_children ä¸è¶³ | å¢å¤§ fanout æˆ–å¼€å¯ repair |
| duplication é«˜ | çˆ¶é›†åˆé«˜åº¦é‡å  | ç”¨ multi-pivot æˆ–åŠ  diversify é€»è¾‘ |

---

## 10. FAQ

**Q: ä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå¬å›æŒ‡æ ‡ï¼Ÿ**  
A: `recall_at_k` æ˜¯æ€»ä½“ï¼›`avg_individual_recall` åæ˜ æŸ¥è¯¢ç¦»æ•£åº¦ã€‚

**Q: Hybrid ä¸é‡‡æ ·æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ**  
A: ä¿è¯å®éªŒç»“æœåªå—å±‚çº§ç»“æ„å½±å“ï¼Œæ’é™¤éšæœºæ€§ã€‚

**Q: å¯ä»¥æ¢è·ç¦»åº¦é‡å—ï¼Ÿ**  
A: å¯ä»¥ï¼Œæ„å»º HNSW æ—¶ä¼ å…¥è‡ªå®šä¹‰ `distance_func`ã€‚

**Q: K-Means ä¼šä¸ä¼šé‡å¤è¿è¡Œï¼Ÿ**  
A: åªåœ¨ SharedContext ä¸­æ‰§è¡Œä¸€æ¬¡ï¼›Hybrid ä¼šåœ¨ prepare é˜¶æ®µè¦†ç›– centroidsã€‚

---

## 11. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- è°ƒæ•´ MiniBatchKMeans `batch_size` ä»¥é€‚é…å†…å­˜ã€‚
- ç»Ÿä¸€è®¾å®šéšæœºç§å­ä¿è¯å¤ç°ã€‚
- Ground Truth åªå¯¹æ¯ä¸ª k è®¡ç®—ä¸€æ¬¡ï¼ˆè„šæœ¬å·²å®ç°ï¼‰ã€‚
- å¤§è§„æ¨¡æ—¶å¯è€ƒè™‘ Numba / Cython / GPU åŠ é€Ÿï¼ˆæœªæ¥ï¼‰ã€‚
- é¿å…æç«¯ `n_probe * k_children` ç»„åˆï¼ˆ>2e5ï¼‰ã€‚

---

## 12. Roadmapï¼ˆå»ºè®®ï¼‰

| ä¼˜å…ˆçº§ | ç‰¹æ€§ | ä»·å€¼ |
|--------|------|------|
| é«˜ | è‡ªé€‚åº” n_probeï¼ˆåŸºäºè·ç¦» gapï¼‰ | åŠ¨æ€æ€§èƒ½/å¬å›æŠ˜ä¸­ |
| é«˜ | ç´¢å¼•æŒä¹…åŒ–ï¼ˆä¿å­˜/åŠ è½½ï¼‰ | å¤ç”¨æ„å»ºç»“æœ |
| ä¸­ | é‡å¤é™åˆ¶ï¼ˆæ¯å­èŠ‚ç‚¹æœ€å¤§åˆ†é…æ¬¡æ•°ï¼‰ | æ§åˆ¶ duplication |
| ä¸­ | GPU èšç±» & æ‰¹é‡è·ç¦» | ç™¾ä¸‡çº§æ‰©å±• |
| ä¸­ | å»¶è¿Ÿ P50/P95 æŒ‡æ ‡ | SLA è¯„ä¼° |
| ä½ | è¦†ç›–/å¬å›å¯è§†åŒ–å·¥å…· | åˆ†ææ›´ç›´è§‚ |
| ä½ | å­¦ä¹ å¼çˆ¶è·¯ç”± | æ½œåœ¨å¬å›å¢ç›Š |

---

## 13. ä»“åº“ç»“æ„å¿«é€Ÿå‚è€ƒ

```
 datasketch-enhanced/
 â”œâ”€â”€ hnsw/               # HNSW æ ¸å¿ƒå®ç°
 â”œâ”€â”€ hybrid_hnsw/        # å±‚çº§ Hybrid å°è£…
 â”œâ”€â”€ method3/            # K-Means + å¤šç­–ç•¥è¯„ä¼°
 â”œâ”€â”€ docs/               # ç®—æ³•ä¸è®¾è®¡æ–‡æ¡£
 â”œâ”€â”€ optimized_hnsw/     # æœªæ¥æ€§èƒ½ä¼˜åŒ–ä½
 â”œâ”€â”€ sift/               # SIFT ç¤ºä¾‹æ•°æ®
 â””â”€â”€ tests/              # æµ‹è¯•
```

---

## 14. è®¸å¯è¯ä¸å¼•ç”¨

MIT Licenseï¼ˆè§ [LICENSE](LICENSE)ï¼‰ã€‚è‹¥ç”¨äºå­¦æœ¯ç ”ç©¶è¯·å¼•ç”¨æœ¬ä»“åº“ã€‚HNSW åŸè®ºæ–‡ï¼š*Malkov & Yashunin, 2016.*

---

## 15. è‡´è°¢

æ„Ÿè°¢å¼€æº ANN ç¤¾åŒºçš„ç ”ç©¶ä¸å®è·µå¯å‘ï¼Œæ¬¢è¿ Issue / PR / Benchmark è´¡çŒ®ã€‚

---

## 16. æœ€ç®€ä»£ç ç‰‡æ®µ

Baseline HNSWï¼š
```python
from hnsw.hnsw import HNSW
import numpy as np
f = lambda a,b: np.linalg.norm(a-b)
idx = HNSW(distance_func=f, m=16, ef_construction=200)
X = np.random.randn(1000,64).astype(np.float32)
for i,v in enumerate(X):
    idx.insert(i,v)
print(idx.query(X[0], k=10, ef=200))
```

è¿è¡Œç»Ÿä¸€è¯„ä¼°ï¼š
```bash
python method3/tune_kmeans_hnsw_optimized.py --dataset-size 5000 --query-size 50 \
  --n-clusters 32 --k-children 300 --strategy all --k-list 10 --n-probe-list 4,8,12
```

---

ç¥å®éªŒé¡ºåˆ©ï¼ğŸ”
