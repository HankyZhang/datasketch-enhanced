<!-- 自动生成：Hybrid HNSW 实验阶段报告 -->
# Hybrid HNSW 实验阶段综合报告

更新时间：2025-09-11

---
## 目录
1. Executive Summary（管理层速览）  
2. 实验数据总览与关键对比  
3. 结构诊断与原因分析  
4. 性能结论与定位  
5. 风险与当前局限  
6. 分阶段路线图（优先级）  
7. 参数调优经验法则  
8. 脚本资产与改进建议  
9. 24h 内最小补齐事项  
10. 中长期深化方向  
11. 汇报 PPT 建议结构  
12. 一句话总结  
13. 待决策点  
14. 附录：原始关键数据表 & 术语说明  

---
## 1. Executive Summary（管理层速览）
| 主题 | 结论 |
|------|------|
| 初始低召回根因 | 父子映射冗余 + 覆盖率不足（coverage≈0.31），真实近邻未进入候选集合 |
| 关键改进 | Diversification（限制每点分配次数）+ Repair（补全未覆盖点）→ 覆盖率=1.0，冗余显著下降 |
| 效果 | 未优化最佳 recall@10≈0.27 → 优化后局部探测 recall@10≈0.73；全父扫描 recall@10=1.00 |
| 与纯 HNSW 对比 | 中高召回段（~0.73）延迟：Hybrid 2.75 ms vs HNSW 4.17 ms（约 1.5× 加速）；极高召回上限 Hybrid 5.09 ms (1.0 recall) vs HNSW 13.83 ms (~3×) |
| 战略价值 | 构建一个“可连续调控召回/时延”的二阶段检索结构，适用于分层召回 / 低延迟场景 |
| 下一关键动作 | 完成 ef_construction=400 的优化 Hybrid 500-query 全量结果；开展 diversification 参数敏感性实验 |

---
## 2. 实验数据总览与关键对比（5k 数据集, base=4500, queries=500, k=10）

### 2.1 纯 HNSW（ef_construction=300 示例）
| ef_search | 20 | 30 | 40 | 50 | 100 | 150 | 200 | 300 | 400 |
|-----------|----|----|----|----|-----|-----|-----|-----|-----|
| recall@10 | 0.538 | 0.653 | 0.736 | 0.797 | 0.944 | 0.982 | 0.994 | 0.999 | 0.9996 |
| 平均延迟(ms) | 2.66 | 3.83 | 4.17 | 4.70 | 7.19 | 9.21 | 10.79 | 12.85 | 14.13 |

### 2.2 未优化 Hybrid（示例：efc=400, parent_count=21, coverage≈0.311）
| n_probe | 5 | 8 | 10 | 12 |
|---------|---|---|----|----|
| recall@10 | 0.171 | 0.222 | 0.249 | 0.273 |
| 延迟(ms) | 0.63–0.71 | 0.78–0.86 | 0.89–1.24 | 0.95–1.16 |
| avg_candidate_size | ~260–310 | ~300–360 | ~310–420 | ~270–320 |

### 2.3 优化 Hybrid（efc=300, k_children=800, diversify_max=3, repair_min=1, parent_count=24, coverage=1.0）
| n_probe | 5 | 8 | 10 | 12 | 24 (全父) |
|---------|---|---|----|----|-----------|
| recall@10 | 0.426 | 0.577 | 0.656 | 0.728 | 1.000 |
| 延迟(ms) | 1.50 | 2.23 | 2.56 | 2.75 | 5.09 |
| avg_candidate_size | 1037 | 1340 | 1573 | 1788 | 2370 |

### 2.4 关键横向锚点
| 目标召回 | 方案 | 参数 | 延迟(ms) | 说明 |
|----------|------|------|----------|------|
| ~0.73 | 优化 Hybrid | n_probe=12 | 2.75 | 低于 HNSW ef=40 的 4.17 ms |
| ~0.736 | 纯 HNSW | ef_search=40 | 4.17 | 同级召回更慢 |
| ~0.80 | 纯 HNSW | ef_search=50 | 4.70 | Hybrid 当前需提升结构质量或多重覆盖才能匹配 |
| ~0.94 | 纯 HNSW | ef_search=100 | 7.19 | Hybrid 尚未在低 n_probe 下触达 |
| ~1.00 | 优化 Hybrid | n_probe=24 | 5.09 | 全父扫描上界；非常规部署配置 |
| ~0.9996 | 纯 HNSW | ef_search=400 | 13.83 | 高延迟对比 Hybrid 上界 ~3× |

---
## 3. 结构诊断与原因分析
### 3.1 未优化版本问题
* 覆盖率（coverage_fraction）低：0.20–0.36 → 大量点从未进入候选集合
* overlap_unique_fraction ≈ coverage ⇒ 基本“一对一”但稀疏父集合集中在局部空间
* avg_assignment_count ≈ 1.07–1.24：少量冗余没形成有效多样性
* multi_coverage_fraction < 0.2：n_probe 增加无法快速“补洞”

### 3.2 优化版本改进
| 指标 | 未优化 | 优化后 |
|------|--------|--------|
| coverage_fraction | 0.20–0.36 | 1.00 |
| overlap_unique_fraction | ≈ coverage | 1.00（每点唯一分配） |
| avg_assignment_count | ~1.1–1.2 | ~1.07（剩余为 repair 回填） |
| mean_jaccard_overlap | ~0.009–0.010 | ~0.003 | 

### 3.3 后续潜在优化点
* 过度“唯一分配”可能在低 n_probe 下损失可局部重叠带来的召回增幅
* 允许**受控第二父节点**或基于密度的 selective duplication 可提升中段召回
* 在 candidate_size 加速膨胀前引入 top-L 预截断减少排序开销

---
## 4. 性能结论与定位
| 场景 | Hybrid 价值点 | 说明 |
|------|---------------|------|
| 中高召回 (0.6–0.8) | 更低延迟 | n_probe 连续可调；优于 HNSW 相同 recall 下的 ef_search 查询宽度 |
| 极高召回 (接近 1.0) | 上界优势明显 | 全父扫描仍低于 HNSW 高 ef_search 延迟 |
| 部署弹性 | 单一结构多性能点 | 通过 n_probe 动态配置满足 SLA 分层 |

当前瓶颈：
1. 构建时间较长（5k：efc 300–400 需 140–157 s）
2. 中高召回段尚未完全替代 HNSW 0.85+ 区间 → 需要更高结构质量或受控冗余
3. candidate_size 增长（>1500）开始放大 merge/re-rank 成本

---
## 5. 风险与当前局限
| 类别 | 风险 / 局限 | 影响 | 缓解措施 |
|------|-------------|------|-----------|
| 数据规模放大 | 600k 级 brute-force 代价高 | 难验证结构泛化 | 分批 + 使用高 ef HNSW 近似 GT |
| 全父扫描 | 非真实生产策略 | 夸大上界 | 明确标注“理论上界” |
| 单一 k=10 | 泛化不确定 | 业务适配不充分 | 扩展 k=1 / 20 / 50 |
| 结构过度唯一 | 可能损失快速回补能力 | 中段召回欠提升 | 受控重复 / 二次指派 |
| 构建耗时 | 更新频繁场景受限 | 降低可用性 | 增量层更新 / 冷热分层 |
| 内存未量化 | 难以做容量规划 | 风险评估滞后 | 引入结构对象内存测量 |

---
## 6. 分阶段路线图（优先级）
### 批次 1（立即）
1. 完成：优化 Hybrid efc=400, queries=500 全量运行 → 生成 `hybrid_optimized_5k_full.csv`
2. 衍生：生成 recall–latency 汇总 CSV + 折线图（baseline vs unopt vs opt）
3. 额外：k=1 / k=20 二次统计（重用 ground truth）

### 批次 2（结构探索）
4. diversify_max ∈ {2,3,4,5} 敏感性 + 指标：coverage / recall / candidate_size
5. repair_min >1 测试（区分稀疏/密集区域）
6. parent_level ∈ {1,2,3} → parent_count vs recall 曲线

### 批次 3（算法效率）
7. 自适应 n_probe（距离改进率 / 候选增量阈值）
8. 候选合并前 top-L 预截断（L≈α*k*n_probe）
9. 统计：距离计算次数、冗余去重率

### 批次 4（规模与资源）
10. 20k 集验证趋势（queries=200）
11. 内存画像：graph / mapping / cache 大小
12. 近似 ground truth：使用 baseline HNSW ef_search 高值替代

### 批次 5（深化 & 稳健性）
13. 600k quick 模式试点（单/双配置）
14. Profiling：cProfile / segmentation（构建 vs 查询）
15. 中断恢复：持久化 parent-child 映射与参数哈希

---
## 7. 参数调优经验法则
| 目标 | 初始建议 | 调整方向 |
|------|----------|----------|
| 中速中召回 (0.6–0.7) | efc=300, k_children=800, n_probe=8 | recall 低→增 n_probe / 增 efc |
| 高召回 (0.7–0.8) | efc=300–400, n_probe=12 | 仍不足→允许受控多重覆盖 |
| 极高召回 | n_probe=parent_count | 降低 parent_count 以减时延 |
| 降低延迟 | 降 n_probe / 降 k_children | 监控 recall 曲线斜率 |
| 覆盖不满 | 降 diversify_max 或提 repair_min | 观察冗余度（mean_jaccard_overlap） |
| candidate_size 过大 | 引入预截断 L | 控制排序成本 |
| 构建质量不足 | 提升 efc (300→400→600) | 评估边际收益 vs 构建时间 |

---
## 8. 脚本资产与改进建议
| 脚本 | 功能 | 建议改进 |
|------|------|----------|
| `baseline_hnsw_benchmark.py` | 纯 HNSW 基线 | 支持多 k / JSON 输出 |
| `unoptimized_5k.csv` | 未优化结果集 | 保留但避免重复汇入 |
| `diversified_hybrid_benchmark.py` | 优化 Hybrid 跑批 | 已缓存 ground truth；加入 diversify sweep | 
| `compare_benchmarks.py` | 汇总对比 | 增加自动绘图（matplotlib / plotly） |
| `large_unoptimized_benchmark.py` | 大规模未优化框架 | 复用或近似 ground truth 模式 |
| `hnsw_hybrid_evaluation.py` | 核心与评估 | 添加 adaptive probing hook |

---
## 9. 24h 内最小补齐事项
1. 运行 efc=400 优化 Hybrid（完整 500 queries）
2. 追加 k=1 / k=20 指标（利用已有 top-k 列表裁剪）
3. 生成 recall–latency CSV & 折线（用于汇报）
4. 整理图表说明文字（放入 PPT）

---
## 10. 中长期深化方向（选做）
| 方向 | 描述 | 预期收益 |
|------|------|----------|
| 聚类辅助父节点 | k-means 质心替代层级抽样 | 更均匀覆盖 / 降低 parent_count |
| 自适应 probing | 基于距离下降率停止 | 降低平均查询时间 15–30% |
| Selective multi-cover | 高密度区域允许第二父 | 提升中段召回（0.7→0.8+） |
| 候选分桶分层排序 | 先局部粗排再精排 | 降低排序 O(N log N) 成本 |
| 近似 GT 体系 | 高 ef_search HNSW 代替 brute-force | 支撑大规模迭代速度 |
| 内存占用剖析 | 精准统计结构大小 | 指导参数上限规划 |

---
## 11. 汇报 PPT 建议结构
1. 背景：为何需要二阶段 Hybrid  
2. 初始问题：低召回 & 冗余结构  
3. 改进方法：Diversification + Repair  
4. 数据对比：三种方法关键表  
5. 召回-延迟曲线（标注转折点）  
6. 上界 vs 实际可部署说明  
7. 成本（构建时间 / 查询时间）  
8. 风险与缓解  
9. 路线图与 ROI  
10. 决策请求（资源 & 实验许可）  

---
## 12. 一句话总结
> 通过结构去冗余与全覆盖修复，Hybrid 在中高召回区间较纯 HNSW 提供 ~1.5× 查询加速，并在接近满召回时展现 ~3× 上界潜力；后续通过受控多重覆盖与自适应 probing 仍有进一步优化空间。

---
## 13. 待决策点（需要管理层确认）
| 项目 | 说明 | 需决定 |
|------|------|--------|
| efc≥600 扩展 | 进一步提升结构质量 | 是否投入构建时间 |
| 自适应 n_probe 研发 | 算法工程开销 | 是否列为下阶段优先 |
| 20k→600k 扩展试点 | 需要更多算力 | 是否批准资源窗口 |
| 聚类辅助父节点 | 初始开发成本 | 是否探索替换策略 |

---
## 14. 附录
### 14.1 关键字段释义
| 字段 | 解释 |
|------|------|
| coverage_fraction | 覆盖到至少 1 个父节点的子向量比例 |
| overlap_unique_fraction | (唯一覆盖点数 / 被覆盖点数)；=1 表示无多重覆盖 |
| avg_assignment_count | 每个被覆盖点平均父节点计数 |
| multi_coverage_fraction | 被≥2父节点覆盖的点比例 |
| parent_count | 父节点数（抽象“簇”数量） |
| candidate_size | 合并候选集合大小（平均） |

### 14.2 原始优化 Hybrid 结果（efc=300, k_children=800）
| n_probe | recall@10 | avg_query_time(ms) | coverage | parent_count | avg_candidate_size |
|---------|-----------|-------------------|----------|--------------|-------------------|
| 5 | 0.426 | 1.498 | 1.0 | 24 | 1037 |
| 8 | 0.577 | 2.225 | 1.0 | 24 | 1340 |
| 10 | 0.656 | 2.558 | 1.0 | 24 | 1573 |
| 12 | 0.728 | 2.752 | 1.0 | 24 | 1788 |
| 24 (full) | 1.000 | 5.093 | 1.0 | 24 | 2370 |

### 14.3 纯 HNSW 延迟 - 召回曲线（节选）
| ef_search | recall@10 | avg_query_time(ms) |
|-----------|-----------|--------------------|
| 20 | 0.538 | 2.66 |
| 40 | 0.736 | 4.17 |
| 50 | 0.797 | 4.70 |
| 100 | 0.944 | 7.19 |
| 150 | 0.982 | 9.21 |
| 200 | 0.994 | 10.79 |
| 300 | 0.999 | 12.85 |
| 400 | 0.9996 | 13.83 |

### 14.4 未优化 Hybrid（部分行示例，efc=400）
| n_probe | recall@10 | avg_query_time(ms) | coverage | parent_count |
|---------|-----------|-------------------|----------|--------------|
| 5 | 0.1708 | 0.63–0.71 | 0.311 | 21 |
| 8 | 0.2216 | 0.78–0.86 | 0.311 | 21 |
| 10 | 0.2492 | 0.89–1.24 | 0.311 | 21 |
| 12 | 0.2726 | 0.95–1.16 | 0.311 | 21 |

---
（完）
