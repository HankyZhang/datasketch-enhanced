# ğŸ” Hybrid HNSW å¬å›ç‡ä½çš„æ ¹æœ¬åŸå› åˆ†æ

## é—®é¢˜æè¿°
è™½ç„¶Hybridç³»ç»Ÿçš„å€™é€‰é›†å¤§å°æ¥è¿‘åŸå§‹æ•°æ®é›†ï¼ˆ48.1% - 80%è¦†ç›–ç‡ï¼‰ï¼Œä½†å¬å›ç‡åªæœ‰37.8%ï¼Œè¿œä½äºé¢„æœŸã€‚

## ğŸ§ª å®éªŒå‘ç°

### å®éªŒè®¾ç½®
- æ•°æ®é›†ï¼š1000ä¸ª32ç»´å‘é‡
- æŸ¥è¯¢ï¼šä½¿ç”¨æ•°æ®é›†ä¸­çš„å‘é‡ä½œä¸ºæŸ¥è¯¢ï¼ˆID: 131ï¼‰
- é¢„æœŸï¼šæŸ¥è¯¢è‡ªèº«åº”è¯¥æ˜¯æœ€è¿‘é‚»ï¼ˆè·ç¦»=0ï¼‰

### ç»“æœå¯¹æ¯”
| æ–¹æ³• | Top-10ç»“æœ | å¬å›ç‡ | é—®é¢˜ |
|------|-----------|-------|------|
| çœŸå®ç­”æ¡ˆ | [131, ...å…¶ä»–9ä¸ª] | 100% | æŸ¥è¯¢è‡ªèº«åº”æ’ç¬¬ä¸€ |
| åŸºçº¿HNSW | [131, ...æ­£ç¡®é‚»å±…] | 100% | âœ… å®Œç¾æ‰¾åˆ° |
| Hybrid | [335, 491, 511, ...] | 0% | âŒ è¿è‡ªèº«éƒ½æ‰¾ä¸åˆ° |

## ğŸ” æ ¹æœ¬é—®é¢˜åˆ†æ

### 1. çˆ¶èŠ‚ç‚¹é€‰æ‹©é—®é¢˜
```
HNSW Level 2 èŠ‚ç‚¹: [116, 939, 410]  â† è¿™äº›ä¸æ˜¯èšç±»ä¸­å¿ƒï¼
æŸ¥è¯¢å‘é‡ 131 çš„æœ€è¿‘çˆ¶èŠ‚ç‚¹: 116, 939, 410
ä½†å‘é‡ 131 å¯èƒ½æ ¹æœ¬ä¸åœ¨è¿™äº›çˆ¶èŠ‚ç‚¹çš„childrenåˆ—è¡¨ä¸­ï¼
```

### 2. çˆ¶å­æ˜ å°„é—®é¢˜
```
Parent 116: 199 children (é€šè¿‡HNSW.queryæ‰¾åˆ°çš„é‚»å±…)
Parent 939: 199 children
Parent 410: 199 children
è¦†ç›–ç‡: 48.1% (481/1000)

é—®é¢˜ï¼šå‘é‡131ä¸åœ¨ä»»ä½•ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„childrenä¸­ï¼
```

### 3. æ¶æ„çŸ›ç›¾
```
çˆ¶èŠ‚ç‚¹é€‰æ‹©: åŸºäºç®€å•æ¬§å¼è·ç¦»
   Query â†’ æ‰¾æœ€è¿‘çš„çˆ¶èŠ‚ç‚¹

çˆ¶å­æ˜ å°„æ„å»º: åŸºäºHNSWå›¾æœç´¢
   Parent â†’ HNSW.query(parent, k=200) â†’ children

çŸ›ç›¾: è·ç¦»æœ€è¿‘çš„çˆ¶èŠ‚ç‚¹ â‰  HNSWå›¾ä¸­æœ€ç›¸å…³çš„é‚»å±…
```

## ğŸ’¡ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

### HNSW Level 2 èŠ‚ç‚¹çš„çœŸå®æ€§è´¨
- **ä¸æ˜¯èšç±»ä¸­å¿ƒ**ï¼šåªæ˜¯åœ¨æ„å»ºè¿‡ç¨‹ä¸­è¢«éšæœºæå‡åˆ°é«˜å±‚çš„èŠ‚ç‚¹
- **ä¸ä»£è¡¨å±€éƒ¨ç»“æ„**ï¼šå®ƒä»¬çš„å­˜åœ¨æ˜¯ä¸ºäº†æä¾›é•¿è·ç¦»è¿æ¥ï¼Œä¸æ˜¯ä¸ºäº†è¡¨ç¤ºæ•°æ®åˆ†å¸ƒ
- **åˆ†å¸ƒç¨€ç–**ï¼šåªæœ‰2-8ä¸ªèŠ‚ç‚¹è¦ä»£è¡¨1000ä¸ªå‘é‡ï¼Œå¤©ç„¶è¦†ç›–ä¸è¶³

### çˆ¶å­æ˜ å°„çš„é—®é¢˜
```python
# å½“å‰æ–¹æ³•ï¼šæ¯ä¸ªçˆ¶èŠ‚ç‚¹æ‰¾200ä¸ªHNSWé‚»å±…
for parent_id in parent_ids:
    children = hnsw.query(parent_vector, k=200)  # åŸºäºå›¾æœç´¢
    parent_child_map[parent_id] = children

# é—®é¢˜ï¼šHNSW.query()èµ°çš„æ˜¯å›¾çš„è·¯å¾„ï¼Œä¸æ˜¯ç®€å•çš„è·ç¦»æ’åº
# ç»“æœï¼šæŸäº›å‘é‡å¯èƒ½å®Œå…¨ä¸åœ¨ä»»ä½•çˆ¶èŠ‚ç‚¹çš„childrenä¸­
```

### æœç´¢æ—¶çš„äºŒæ¬¡é—®é¢˜
```python
# æœç´¢æ—¶ï¼šåŸºäºç®€å•è·ç¦»é€‰æ‹©çˆ¶èŠ‚ç‚¹
selected_parents = find_closest_parents(query, n_probe=5)  # æ¬§å¼è·ç¦»

# ä½†childrenæ˜¯é€šè¿‡HNSWå›¾æœç´¢å¾—åˆ°çš„ï¼Œä¸¤è€…ä¸åŒ¹é…ï¼
```

## ğŸš€ è§£å†³æ–¹æ¡ˆ

### 1. çœŸæ­£çš„èšç±»æ–¹æ³•
```python
from sklearn.cluster import KMeans

# ç”¨çœŸå®èšç±»æ›¿ä»£HNSWå±‚çº§
kmeans = KMeans(n_clusters=n_parents)
parent_centers = kmeans.fit(dataset).cluster_centers_
parent_assignments = kmeans.labels_  # æ¯ä¸ªå‘é‡å±äºå“ªä¸ªèšç±»
```

### 2. ä¸€è‡´çš„è·ç¦»è®¡ç®—
```python
# ç¡®ä¿çˆ¶å­æ˜ å°„å’Œæœç´¢ä½¿ç”¨ç›¸åŒçš„ç­–ç•¥
def build_parent_child_mapping_consistent(self):
    for parent_id in self.parent_ids:
        # ç›´æ¥åŸºäºè·ç¦»ï¼Œä¸ä½¿ç”¨HNSW.query
        distances = [np.linalg.norm(self.dataset[parent_id] - vec) 
                    for vec in self.dataset]
        closest_indices = np.argsort(distances)[:self.k_children]
        self.parent_child_map[parent_id] = closest_indices
```

### 3. å¢åŠ è¦†ç›–ç‡
```python
# ç¡®ä¿æ¯ä¸ªå‘é‡è‡³å°‘è¢«ä¸€ä¸ªçˆ¶èŠ‚ç‚¹è¦†ç›–
def ensure_full_coverage(self):
    covered = set()
    for children in self.parent_child_map.values():
        covered.update(children)
    
    uncovered = set(range(len(self.dataset))) - covered
    if uncovered:
        # å°†æœªè¦†ç›–çš„å‘é‡åˆ†é…ç»™æœ€è¿‘çš„çˆ¶èŠ‚ç‚¹
        for vec_id in uncovered:
            closest_parent = find_closest_parent(vec_id)
            self.parent_child_map[closest_parent].append(vec_id)
```

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

| æ”¹è¿›æ–¹æ¡ˆ | é¢„æœŸè¦†ç›–ç‡ | é¢„æœŸå¬å›ç‡ | å®ç°éš¾åº¦ |
|---------|-----------|-----------|----------|
| å½“å‰Hybrid | 48.1% | 37.8% | - |
| ä¸€è‡´è·ç¦»è®¡ç®— | 60-70% | 50-65% | ç®€å• |
| çœŸå®èšç±» | 85-95% | 70-85% | ä¸­ç­‰ |
| å®Œå…¨è¦†ç›–ä¿è¯ | 100% | 80-90% | ä¸­ç­‰ |

## ğŸ¯ ç»“è®º

**Hybridç³»ç»Ÿå¬å›ç‡ä½çš„æ ¹æœ¬åŸå› **ï¼š
1. **å‡è®¾é”™è¯¯**ï¼šHNSWé«˜å±‚èŠ‚ç‚¹ä¸æ˜¯å¥½çš„èšç±»ä¸­å¿ƒ
2. **æ–¹æ³•ä¸ä¸€è‡´**ï¼šçˆ¶èŠ‚ç‚¹é€‰æ‹©ç”¨æ¬§å¼è·ç¦»ï¼Œçˆ¶å­æ˜ å°„ç”¨HNSWå›¾æœç´¢
3. **è¦†ç›–ä¸è¶³**ï¼šçˆ¶èŠ‚ç‚¹å¤ªå°‘ï¼Œæ— æ³•ä»£è¡¨æ•´ä¸ªæ•°æ®åˆ†å¸ƒ
4. **æ¶æ„ç¼ºé™·**ï¼šä¸¤é˜¶æ®µä¹‹é—´å­˜åœ¨è¯­ä¹‰é¸¿æ²Ÿ

**è§£å†³ç­–ç•¥**ï¼šéœ€è¦é‡æ–°è®¾è®¡çˆ¶å­ç»“æ„ï¼Œä½¿ç”¨çœŸæ­£çš„èšç±»æ–¹æ³•æˆ–ç¡®ä¿æ–¹æ³•ä¸€è‡´æ€§ã€‚
