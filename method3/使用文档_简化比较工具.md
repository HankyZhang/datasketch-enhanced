# K-Means HNSW 性能比较工具使用文档

## 📖 概述

这是一个用于比较三种向量搜索方法性能的简化工具，专门设计用于评估和对比不同算法在相似性搜索任务中的表现。

### 🎯 支持的算法

1. **HNSW** (分层可导航小世界图)
   - 基于图的近似最近邻搜索
   - 特点：高精度、快速查询
   - 适用：通用向量搜索场景

2. **Pure K-Means** (纯K-Means聚类)
   - 基于聚类的向量搜索
   - 特点：内存效率高、构建快速
   - 适用：大规模数据集的粗糙搜索

3. **K-Means HNSW** (混合两阶段搜索)
   - 结合K-Means粗搜索和HNSW精搜索
   - 特点：平衡精度和效率
   - 适用：需要高精度的大规模搜索

## 🚀 快速开始

### 基本使用

```bash
# 使用默认参数进行快速测试
python method3/simple_comparison.py

# 指定数据集大小和查询数量
python method3/simple_comparison.py --dataset-size 10000 --query-size 100

# 使用SIFT数据集
python method3/simple_comparison.py --use-sift --dataset-size 50000 --query-size 1000
```

### 完整参数示例

```bash
python method3/simple_comparison.py \
    --dataset-size 20000 \
    --query-size 200 \
    --k 10 \
    --n-clusters 128 \
    --dimension 256 \
    --save-results
```

## 🔧 命令行参数详解

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--dataset-size` | int | 5000 | 数据集大小（向量数量） |
| `--query-size` | int | 50 | 查询向量数量 |
| `--dimension` | int | 128 | 向量维度（仅合成数据） |
| `--k` | int | 10 | 返回的最近邻数量 |
| `--n-clusters` | int | 64 | K-Means聚类中心数量 |
| `--use-sift` | flag | false | 使用SIFT数据集替代合成数据 |
| `--save-results` | flag | false | 将结果保存到JSON文件 |

## 📊 性能指标说明

### 主要评估指标

1. **召回率 (Recall@K)**
   - 定义：返回结果中真实近邻的比例
   - 计算：正确结果数 / (查询数量 × K)
   - 范围：0.0 - 1.0（越高越好）

2. **查询时间 (Query Time)**
   - 定义：单次查询的平均响应时间
   - 单位：毫秒 (ms)
   - 说明：越低越好

3. **构建时间 (Build Time)**
   - 定义：索引构建所需的时间
   - 单位：秒 (s)
   - 说明：一次性成本，影响系统部署

## 🏗️ 算法工作原理

### HNSW算法
```
1. 构建多层图结构
2. 上层：稀疏连接，快速导航
3. 底层：密集连接，精确搜索
4. 查询时从顶层逐层下降搜索
```

### K-Means算法
```
1. 将数据聚类为k个簇
2. 查询时找到最近的聚类中心
3. 在对应簇内进行精确搜索
4. 返回距离最近的k个点
```

### K-Means HNSW混合算法
```
第一阶段(粗搜索)：
1. 使用K-Means找到最相关的聚类
2. 选择top-n个聚类中心

第二阶段(精搜索)：
1. 在选定聚类对应的HNSW子图中搜索
2. 合并多个聚类的搜索结果
3. 返回全局最优的k个结果
```

## 📈 结果解读指南

### 输出示例

```
性能比较结果
================================================================================
配置: k=10, 聚类数=64
数据集大小: 10000, 查询数量: 100

HNSW:
  ef=50        召回率: 0.8234, 平均查询时间: 1.23ms
  ef=100       召回率: 0.9012, 平均查询时间: 2.45ms
  ef=200       召回率: 0.9456, 平均查询时间: 4.67ms

Pure K-Means:
  n_probe=1    召回率: 0.6789, 平均查询时间: 0.89ms
  n_probe=5    召回率: 0.7654, 平均查询时间: 1.56ms
  n_probe=10   召回率: 0.8123, 平均查询时间: 2.34ms

K-Means HNSW:
  n_probe=1    召回率: 0.8567, 平均查询时间: 1.78ms
  n_probe=5    召回率: 0.9234, 平均查询时间: 3.45ms
  n_probe=10   召回率: 0.9567, 平均查询时间: 5.67ms

最佳召回率: K-Means HNSW - 0.9567 (查询时间: 5.67ms)
```

### 性能分析

**HNSW表现分析：**
- ✅ 高召回率，特别是ef=200时
- ⚠️ 参数ef需要仔细调优
- 💡 适合对精度要求高的场景

**Pure K-Means表现分析：**
- ✅ 查询速度最快
- ⚠️ 召回率相对较低
- 💡 适合大规模快速筛选

**K-Means HNSW表现分析：**
- ✅ 最佳召回率
- ⚠️ 查询时间略高
- 💡 最佳的精度-效率平衡

## ⚙️ 参数调优建议

### 数据集大小相关

| 数据集规模 | 推荐n_clusters | 推荐ef值 | 推荐n_probe |
|------------|----------------|----------|-------------|
| < 10K | 32-64 | 100-200 | 3-5 |
| 10K-100K | 64-128 | 200-400 | 5-10 |
| > 100K | 128-256 | 400-800 | 10-20 |

### 性能优先级调优

**优先追求召回率：**
```bash
python simple_comparison.py \
    --n-clusters 128 \
    --k 20
# 建议测试更大的ef和n_probe值
```

**优先追求查询速度：**
```bash
python simple_comparison.py \
    --n-clusters 32 \
    --k 5
# 建议使用较小的ef和n_probe值
```

**平衡精度和速度：**
```bash
python simple_comparison.py \
    --n-clusters 64 \
    --k 10
# 使用默认参数通常能获得良好平衡
```

## 🔍 高级使用场景

### 1. 学术研究

```bash
# 全面的性能评估
python simple_comparison.py \
    --use-sift \
    --dataset-size 100000 \
    --query-size 1000 \
    --k 10 \
    --save-results

# 分析不同数据集规模的影响
for size in 1000 5000 10000 50000; do
    python simple_comparison.py \
        --dataset-size $size \
        --save-results \
        > results_$size.log
done
```

### 2. 生产环境选型

```bash
# 模拟真实查询负载
python simple_comparison.py \
    --dataset-size 1000000 \
    --query-size 10000 \
    --k 5 \
    --dimension 512 \
    --save-results
```

### 3. 算法优化验证

```bash
# 测试不同聚类数的影响
for clusters in 32 64 128 256; do
    python simple_comparison.py \
        --n-clusters $clusters \
        --save-results
done
```

## 📁 输出文件说明

当使用 `--save-results` 参数时，工具会生成 `simple_comparison_results.json` 文件，包含：

```json
{
  "results": [
    {
      "method": "HNSW",
      "recall": 0.9234,
      "avg_query_time_ms": 2.45,
      "ef": 100
    }
  ],
  "optimization": {
    "best_params": {
      "n_clusters": 64,
      "n_probe": 5,
      "recall": 0.9567
    }
  },
  "config": {
    "k": 10,
    "dataset_size": 10000,
    "query_size": 100
  },
  "timestamp": "2025-09-22 10:30:45"
}
```

## 🐛 常见问题解决

### 问题1：内存不足
```
错误：MemoryError
解决：减少dataset-size参数
推荐：--dataset-size 5000
```

### 问题2：运行时间过长
```
原因：数据集过大或查询数量过多
解决：
- 减少--query-size
- 使用更小的--dataset-size进行初步测试
```

### 问题3：召回率异常低
```
原因：参数设置不当
解决：
- 增加n_clusters
- 增加ef值
- 检查数据质量
```

### 问题4：SIFT数据加载失败
```
错误：SIFT数据加载失败
解决：
1. 检查sift目录是否存在
2. 确认sift_base.fvecs和sift_query.fvecs文件
3. 使用合成数据：不添加--use-sift参数
```

## 🔗 相关资源

- **HNSW论文**: "Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs"
- **K-Means算法**: sklearn.cluster.MiniBatchKMeans文档
- **SIFT数据集**: http://corpus-texmex.irisa.fr/

## 📞 技术支持

如果遇到问题或需要功能扩展，请：
1. 检查本文档的常见问题部分
2. 确认命令行参数正确性
3. 查看控制台输出的错误信息
4. 尝试使用更小的数据集进行测试

---

*最后更新时间：2025年9月22日*
