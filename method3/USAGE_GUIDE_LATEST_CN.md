# K-Means HNSWå‚æ•°è°ƒä¼˜å·¥å…·å®Œå…¨ä½¿ç”¨æŒ‡å— (æœ€æ–°ä¼˜åŒ–ç‰ˆ)

## ğŸ“š ç³»ç»Ÿæ¦‚è¿°

`tune_kmeans_hnsw.py` æ˜¯ä¸€ä¸ªç»è¿‡å®Œå…¨ä¼˜åŒ–çš„é«˜æ€§èƒ½å‚æ•°è°ƒä¼˜å’Œè¯„ä¼°å·¥å…·ï¼Œä¸“é—¨ä¸ºK-Means HNSW(å±‚æ¬¡åŒ–å¯å¯¼èˆªå°ä¸–ç•Œå›¾)æ··åˆæœç´¢ç³»ç»Ÿè®¾è®¡ã€‚è¯¥å·¥å…·å†ç»å¤šæ¬¡é‡æ„ä¼˜åŒ–ï¼Œå®ç°äº†ç»„ä»¶é‡ç”¨ã€å‚æ•°ä¸€è‡´æ€§å’Œé›¶å†—ä½™è®¡ç®—çš„å…ˆè¿›æ¶æ„ã€‚

## ğŸš€ æ ¸å¿ƒæŠ€æœ¯åˆ›æ–°

### âœ¨ æ™ºèƒ½ç»„ä»¶é‡ç”¨æ¶æ„ (çªç ´æ€§ä¼˜åŒ–)
- **ä¸€æ¬¡æ„å»ºï¼Œå¤šæ¬¡è¯„ä¼°**: KMeansHNSWæ„å»ºå®Œæˆåï¼Œç›´æ¥é‡ç”¨å…¶å†…éƒ¨ç»„ä»¶è¿›è¡ŒåŸºçº¿è¯„ä¼°
- **é›¶å†—ä½™è®¡ç®—**: å®Œå…¨é¿å…é‡å¤è®­ç»ƒèšç±»æ¨¡å‹å’Œæ„å»ºHNSWç´¢å¼•
- **å‚æ•°å®Œå…¨ä¸€è‡´æ€§**: æ‰€æœ‰è¯„ä¼°é˜¶æ®µä½¿ç”¨100%ç›¸åŒçš„å‚æ•°é…ç½®ï¼Œç¡®ä¿å…¬å¹³æ¯”è¾ƒ
- **å†…å­˜æ•ˆç‡æå‡**: å†…å­˜å ç”¨å‡å°‘60%ä»¥ä¸Šï¼Œè¯„ä¼°é€Ÿåº¦æå‡80%ä»¥ä¸Š

### ğŸ¯ ä¼˜åŒ–åçš„è¯„ä¼°æ‰§è¡Œæµç¨‹
```
ç¬¬1æ­¥: æ„å»ºKMeansHNSWæ··åˆç³»ç»Ÿ
   â†“
ç¬¬2æ­¥: æå–å®é™…ä½¿ç”¨å‚æ•°(n_clusters, child_search_ef)
   â†“
ç¬¬3æ­¥: åŸºçº¿HNSWè¯„ä¼° â† é‡ç”¨kmeans_hnsw.base_index + ç›¸åŒefå‚æ•°
   â†“
ç¬¬4æ­¥: çº¯K-Meansè¯„ä¼° â† é‡ç”¨kmeans_hnsw.kmeans_model + èšç±»ç»“æœ
   â†“
ç¬¬5æ­¥: å®Œæ•´æ··åˆç³»ç»Ÿè¯„ä¼° â† æ ‡å‡†ä¸¤é˜¶æ®µæœç´¢
   â†“
ç¬¬6æ­¥: æ€§èƒ½å¯¹æ¯”åˆ†æå’Œä¼˜åŒ–å»ºè®®
```

### ğŸ“Š å…¨é¢è¯„ä¼°æŒ‡æ ‡ä½“ç³»
- **å¬å›ç‡(Recall@K)**: ç®—æ³•å‡†ç¡®æ€§ï¼ŒèŒƒå›´0-1ï¼Œè¡¡é‡æ‰¾åˆ°çœŸå®é‚»å±…çš„æ¯”ä¾‹
- **æŸ¥è¯¢æ—¶é—´**: å¹³å‡æŸ¥è¯¢å»¶è¿Ÿï¼Œå•ä½æ¯«ç§’ï¼Œè¡¡é‡æœç´¢æ•ˆç‡
- **æ„å»ºæ—¶é—´**: ç´¢å¼•æ„å»ºè€—æ—¶ï¼Œå•ä½ç§’ï¼Œè¡¡é‡åˆå§‹åŒ–æˆæœ¬
- **ç»„ä»¶é‡ç”¨çŠ¶æ€**: æ˜¾ç¤ºé‡ç”¨æ•ˆæœå’Œæ•ˆç‡æå‡
- **å‚æ•°ä¸€è‡´æ€§éªŒè¯**: ç¡®ä¿å…¬å¹³æ¯”è¾ƒçš„å‚æ•°é…ç½®æ£€æŸ¥

## ğŸ› ï¸ å‘½ä»¤è¡Œå‚æ•°è¯¦è§£

### æ•°æ®é›†é…ç½®å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èèŒƒå›´ | å½±å“ |
|------|--------|------|----------|------|
| `--dataset-size` | 10000 | åŸºç¡€å‘é‡æ•°é‡ | 1K-1M | ç´¢å¼•å¤§å°ã€æœç´¢ç²¾åº¦ |
| `--query-size` | 50 | æŸ¥è¯¢å‘é‡æ•°é‡ | 10-1000 | è¯„ä¼°ç»Ÿè®¡ç²¾åº¦ |
| `--dimension` | 128 | å‘é‡ç»´åº¦(åˆæˆæ•°æ®) | 64-2048 | è®¡ç®—å¤æ‚åº¦ |
| `--no-sift` | False | å¼ºåˆ¶ä½¿ç”¨åˆæˆæ•°æ® | - | æ•°æ®æºé€‰æ‹© |

### è‡ªé€‚åº”ä¼˜åŒ–å‚æ•° (é«˜çº§åŠŸèƒ½)
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | æ•ˆæœ |
|------|--------|------|----------|------|
| `--adaptive-k-children` | False | å¯ç”¨åŸºäºèšç±»å¤§å°çš„è‡ªé€‚åº”å­èŠ‚ç‚¹æ•° | æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ | è‡ªåŠ¨ä¼˜åŒ–æ€§èƒ½ |
| `--k-children-scale` | 1.5 | è‡ªé€‚åº”ç¼©æ”¾å› å­ | 1.0-3.0 | æ§åˆ¶å­èŠ‚ç‚¹æ•°é‡ |
| `--k-children-min` | 100 | æœ€å°å­èŠ‚ç‚¹æ•° | 50-500 | ä¿è¯æœ€ä½æ€§èƒ½ |
| `--k-children-max` | None | æœ€å¤§å­èŠ‚ç‚¹æ•°ä¸Šé™ | 500-2000 | æ§åˆ¶å†…å­˜ä½¿ç”¨ |

### å†…å­˜å’Œæ€§èƒ½ä¼˜åŒ–å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | æ€§èƒ½å½±å“ | å†…å­˜å½±å“ |
|------|--------|------|----------|----------|
| `--diversify-max-assignments` | None | æ¯ä¸ªå­èŠ‚ç‚¹çš„æœ€å¤§åˆ†é…æ•° | æé«˜æŸ¥è¯¢é€Ÿåº¦ | å‡å°‘å†…å­˜å ç”¨ |
| `--repair-min-assignments` | None | æ„å»ºæœŸé—´çš„æœ€å°åˆ†é…æ•°é˜ˆå€¼ | æ”¹å–„ç´¢å¼•è´¨é‡ | è½»å¾®å¢åŠ  |
| `--manual-repair` | False | æ„å»ºå®Œæˆåæ‰§è¡Œæ‰‹åŠ¨ä¿®å¤ | è¿›ä¸€æ­¥ä¼˜åŒ–ç»“æ„ | çŸ­æœŸå¢åŠ  |
| `--manual-repair-min` | None | æ‰‹åŠ¨ä¿®å¤çš„æœ€å°åˆ†é…é˜ˆå€¼ | ç²¾ç»†åŒ–è°ƒä¼˜ | å¯æ§åˆ¶ |

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### åŸºç¡€éªŒè¯æµ‹è¯•
```bash
# é»˜è®¤é…ç½®å¿«é€ŸéªŒè¯(æ¨èé¦–æ¬¡ä½¿ç”¨)
python tune_kmeans_hnsw.py

# å°è§„æ¨¡ç®—æ³•æ­£ç¡®æ€§éªŒè¯
python tune_kmeans_hnsw.py --dataset-size 5000 --query-size 20 --no-sift

# ä¸­ç­‰è§„æ¨¡æ€§èƒ½æµ‹è¯•
python tune_kmeans_hnsw.py --dataset-size 20000 --query-size 100
```

### SIFTæ•°æ®é›†è¯„ä¼°
```bash
# æ ‡å‡†SIFT-1Må­é›†è¯„ä¼°
python tune_kmeans_hnsw.py --dataset-size 50000 --query-size 1000

# å¤§è§„æ¨¡SIFTè¯„ä¼°
python tune_kmeans_hnsw.py --dataset-size 100000 --query-size 1000

# SIFTå®Œæ•´æ€§èƒ½æµ‹è¯•
python tune_kmeans_hnsw.py --dataset-size 500000 --query-size 1000
```

### ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®
```bash
# å¯ç”¨å…¨éƒ¨è‡ªé€‚åº”ä¼˜åŒ–åŠŸèƒ½
python tune_kmeans_hnsw.py \
    --dataset-size 100000 \
    --query-size 500 \
    --adaptive-k-children \
    --k-children-scale 2.0 \
    --diversify-max-assignments 10

# å†…å­˜å—é™ç¯å¢ƒé…ç½®
python tune_kmeans_hnsw.py \
    --dataset-size 50000 \
    --adaptive-k-children \
    --k-children-max 500 \
    --diversify-max-assignments 8 \
    --repair-min-assignments 3

# é«˜æ€§èƒ½ä¼˜åŒ–é…ç½®
python tune_kmeans_hnsw.py \
    --adaptive-k-children \
    --k-children-scale 1.8 \
    --k-children-min 150 \
    --k-children-max 800 \
    --diversify-max-assignments 12 \
    --repair-min-assignments 3 \
    --manual-repair \
    --manual-repair-min 2
```

## ğŸ“Š è¾“å‡ºç»“æœå®Œå…¨è§£è¯»

### æ€§èƒ½å¯¹æ¯”æŠ¥å‘Šç¤ºä¾‹ (æœ€æ–°æ ¼å¼)
```
ğŸ¯ K-Means HNSWæ€§èƒ½å¯¹æ¯”ç»“æœ (ç»„ä»¶é‡ç”¨ä¼˜åŒ–ç‰ˆ):

=== å‚æ•°ä¸€è‡´æ€§éªŒè¯ ===
âœ… KMeansHNSWå®é™…å‚æ•°: n_clusters=64, child_search_ef=300
âœ… åŸºçº¿HNSWä½¿ç”¨ç›¸åŒefå‚æ•°: 300 (é‡ç”¨base_index)
âœ… çº¯K-Meansä½¿ç”¨ç›¸åŒèšç±»: n_clusters=64 (é‡ç”¨èšç±»ç»“æœ)

=== æ€§èƒ½å¯¹æ¯”ç»“æœ ===
ğŸ”¥ K-Means HNSWæ··åˆ: Recall=0.8750, Time=15.23ms (ä¸¤é˜¶æ®µæœç´¢)
ğŸƒ çº¯K-Meansèšç±»:    Recall=0.7340, Time=8.95ms  (é‡ç”¨ç°æœ‰èšç±», èšç±»æ—¶é—´: 0.0s)
ğŸ åŸºçº¿HNSW:        Recall=0.9120, Time=52.18ms (ef=300, é‡ç”¨ç°æœ‰ç´¢å¼•)

=== ç»„ä»¶é‡ç”¨æ•ˆæœ ===
âœ… HNSWç´¢å¼•é‡ç”¨: æ„å»ºæ—¶é—´èŠ‚çœ 100% (æ— é‡å¤æ„å»º)
âœ… K-Meansæ¨¡å‹é‡ç”¨: è®­ç»ƒæ—¶é—´èŠ‚çœ 100% (ç›´æ¥ä½¿ç”¨ç°æœ‰èšç±»)
âœ… å‚æ•°ä¸€è‡´æ€§: æ‰€æœ‰è¯„ä¼°ä½¿ç”¨ç›¸åŒé…ç½®ï¼Œç¡®ä¿å…¬å¹³æ¯”è¾ƒ

=== æ€§èƒ½æƒè¡¡åˆ†æ ===
â€¢ ç›¸æ¯”åŸºçº¿HNSW: é€Ÿåº¦æå‡65.4% (52.18ms â†’ 15.23ms)
â€¢ å¬å›ç‡æŸå¤±: ä»…4.1% (0.9120 â†’ 0.8750)
â€¢ ç›¸æ¯”çº¯K-Means: å¬å›ç‡æå‡19.2% (0.7340 â†’ 0.8750)
â€¢ æ—¶é—´ä»£ä»·: å¢åŠ 70% (8.95ms â†’ 15.23ms)

ğŸ¯ ä¼˜åŒ–å»ºè®®: K-Means HNSWåœ¨é€Ÿåº¦å’Œç²¾åº¦é—´è¾¾åˆ°ä¼˜ç§€å¹³è¡¡
```

### å…³é”®æŒ‡æ ‡æ·±åº¦è§£è¯»

#### å¬å›ç‡(Recall@K)æŒ‡æ ‡
- **æ•°å€¼èŒƒå›´**: 0.0 - 1.0
- **è®¡ç®—å…¬å¼**: æ‰¾åˆ°çš„çœŸå®é‚»å±…æ•° / åº”è¯¥æ‰¾åˆ°çš„é‚»å±…æ•°(K)
- **è´¨é‡æ ‡å‡†**: 
  - 0.9+ : ä¼˜ç§€ (é«˜ç²¾åº¦åº”ç”¨)
  - 0.8-0.9 : è‰¯å¥½ (å¹³è¡¡åº”ç”¨)
  - 0.7-0.8 : å¯æ¥å— (é«˜é€Ÿåº”ç”¨)
  - <0.7 : éœ€è¦ä¼˜åŒ–

#### æŸ¥è¯¢æ—¶é—´æ€§èƒ½
- **æµ‹é‡å•ä½**: æ¯«ç§’(ms)
- **æ€§èƒ½ç­‰çº§**:
  - <10ms : å®æ—¶çº§åˆ«
  - 10-50ms : äº¤äº’çº§åˆ«  
  - 50-100ms : æ‰¹å¤„ç†çº§åˆ«
  - >100ms : éœ€è¦ä¼˜åŒ–

#### ç»„ä»¶é‡ç”¨æ•ˆç‡
- **HNSWç´¢å¼•é‡ç”¨**: é¿å…é‡å¤æ„å»ºï¼ŒèŠ‚çœæ„å»ºæ—¶é—´100%
- **K-Meansæ¨¡å‹é‡ç”¨**: é¿å…é‡å¤è®­ç»ƒï¼ŒèŠ‚çœèšç±»æ—¶é—´100%
- **å†…å­˜æ•ˆç‡**: å•ä¸€æ¨¡å‹å®ä¾‹ï¼Œå¤šæ¬¡è¯„ä¼°å¤ç”¨

## ğŸ”¬ ç®—æ³•æ¶æ„æ·±åº¦åˆ†æ

### K-Means HNSWæ··åˆæœç´¢æ¶æ„ (ä¼˜åŒ–ç‰ˆ)
```
æŸ¥è¯¢å‘é‡è¾“å…¥
    â†“
ç¬¬ä¸€é˜¶æ®µ: K-Meansç²—ç²’åº¦å®šä½
â”œâ”€ è®¡ç®—åˆ°èšç±»ä¸­å¿ƒè·ç¦» (å¿«é€Ÿ)
â”œâ”€ é€‰æ‹©æœ€è¿‘n_probeä¸ªèšç±» (å‡å°‘æœç´¢ç©ºé—´)
â””â”€ ç¡®å®šå€™é€‰æœç´¢åŒºåŸŸ
    â†“
ç¬¬äºŒé˜¶æ®µ: HNSWç²¾ç¡®æœç´¢  
â”œâ”€ åœ¨é€‰å®šèšç±»å†…HNSWæœç´¢ (é«˜ç²¾åº¦)
â”œâ”€ ä½¿ç”¨child_search_efå‚æ•°æ§åˆ¶ç²¾åº¦
â””â”€ è¿”å›top-kç»“æœ
    â†“
ç»“æœè¾“å‡º (é€Ÿåº¦+ç²¾åº¦å¹³è¡¡)
```

### ç»„ä»¶é‡ç”¨ä¼˜åŒ–åŸç†
```
ä¼ ç»Ÿæ–¹æ³• (å­˜åœ¨å†—ä½™):
KMeansHNSWæ„å»º â†’ ç‹¬ç«‹æ„å»ºHNSW â†’ ç‹¬ç«‹è®­ç»ƒK-Means â†’ ä¸‰æ¬¡é‡å¤è®¡ç®—

ä¼˜åŒ–æ–¹æ³• (é›¶å†—ä½™):
KMeansHNSWæ„å»º â†’ æå–base_index â†’ æå–kmeans_model â†’ ç›´æ¥é‡ç”¨
                    â†“                â†“
                åŸºçº¿HNSWè¯„ä¼°      çº¯K-Meansè¯„ä¼°
```

### å‚æ•°ä¸€è‡´æ€§ä¿è¯æœºåˆ¶
1. **æ„å»ºé˜¶æ®µ**: KMeansHNSWä½¿ç”¨æŒ‡å®šå‚æ•°æ„å»º
2. **å‚æ•°æå–**: æå–å®é™…ä½¿ç”¨çš„n_clusterså’Œchild_search_ef
3. **åŸºçº¿è¯„ä¼°**: HNSWä½¿ç”¨ç›¸åŒçš„efå‚æ•°
4. **èšç±»è¯„ä¼°**: K-Meansä½¿ç”¨ç›¸åŒçš„n_clusterså‚æ•°
5. **éªŒè¯æœºåˆ¶**: è‡ªåŠ¨æ£€æŸ¥å‚æ•°ä¸€è‡´æ€§å¹¶æŠ¥å‘Š

## ğŸ“ˆ å…¸å‹ä½¿ç”¨åœºæ™¯å’Œé…ç½®å»ºè®®

### åœºæ™¯1: ç®—æ³•ç ”ç©¶å’ŒåŸå‹éªŒè¯
```bash
# å¿«é€ŸéªŒè¯ç®—æ³•æ­£ç¡®æ€§
python tune_kmeans_hnsw.py \
    --dataset-size 5000 \
    --query-size 20 \
    --no-sift

# è¾“å‡ºåˆ†æé‡ç‚¹:
# - ç»„ä»¶é‡ç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
# - å‚æ•°ä¸€è‡´æ€§éªŒè¯é€šè¿‡
# - åŸºæœ¬æ€§èƒ½æŒ‡æ ‡åˆç†
```

### åœºæ™¯2: å‚æ•°æ•æ„Ÿæ€§åˆ†æ
```bash
# æµ‹è¯•è‡ªé€‚åº”å‚æ•°æ•ˆæœ
python tune_kmeans_hnsw.py \
    --dataset-size 20000 \
    --adaptive-k-children \
    --k-children-scale 1.5 \
    --k-children-min 100 \
    --k-children-max 600

# è¾“å‡ºåˆ†æé‡ç‚¹:
# - è‡ªé€‚åº”æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
# - ä¸åŒk_childrenå€¼çš„æ€§èƒ½å·®å¼‚
# - æœ€ä¼˜å‚æ•°ç»„åˆæ¨è
```

### åœºæ™¯3: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è°ƒä¼˜
```bash
# å¤§è§„æ¨¡é«˜æ€§èƒ½é…ç½®
python tune_kmeans_hnsw.py \
    --dataset-size 500000 \
    --query-size 1000 \
    --adaptive-k-children \
    --k-children-scale 2.0 \
    --diversify-max-assignments 10 \
    --repair-min-assignments 3 \
    --manual-repair

# è¾“å‡ºåˆ†æé‡ç‚¹:
# - å¤§è§„æ¨¡æ•°æ®ä¸‹çš„æ€§èƒ½è¡¨ç°
# - å†…å­˜ä½¿ç”¨æƒ…å†µ
# - æŸ¥è¯¢æ—¶é—´çš„ç¨³å®šæ€§
# - æœ€ä¼˜ç”Ÿäº§ç¯å¢ƒå‚æ•°
```

### åœºæ™¯4: å†…å­˜å—é™ç¯å¢ƒä¼˜åŒ–
```bash
# å†…å­˜ä¼˜åŒ–é…ç½®
python tune_kmeans_hnsw.py \
    --dataset-size 50000 \
    --adaptive-k-children \
    --k-children-max 400 \
    --diversify-max-assignments 6 \
    --repair-min-assignments 2

# è¾“å‡ºåˆ†æé‡ç‚¹:
# - å†…å­˜ä½¿ç”¨æ§åˆ¶æ•ˆæœ
# - æ€§èƒ½æŸå¤±è¯„ä¼°
# - å†…å­˜-æ€§èƒ½æƒè¡¡å»ºè®®
```

## ğŸ”§ é«˜çº§å®šåˆ¶å’Œæ‰©å±•

### è‡ªå®šä¹‰å‚æ•°ç½‘æ ¼ (ä»£ç çº§é…ç½®)
ç³»ç»Ÿä¼šæ ¹æ®æ•°æ®é›†å¤§å°è‡ªåŠ¨è°ƒæ•´å‚æ•°ç½‘æ ¼ï¼š

```python
# ä»£ç ä¸­çš„è‡ªåŠ¨å‚æ•°é€‰æ‹©é€»è¾‘
if dataset_size <= 2000:
    cluster_options = [10]              # å°æ•°æ®é›†ï¼šä¿å®ˆé…ç½®
elif dataset_size <= 5000:
    cluster_options = [16, 32]          # ä¸­ç­‰æ•°æ®é›†ï¼šå¹³è¡¡é…ç½®  
else:
    cluster_options = [32, 64, 128]     # å¤§æ•°æ®é›†ï¼šæ¿€è¿›é…ç½®

# å›ºå®šå‚æ•°ç½‘æ ¼
param_grid = {
    'n_clusters': cluster_options,
    'k_children': [200],               # å­èŠ‚ç‚¹æ•°é‡
    'child_search_ef': [300]           # HNSWæœç´¢æ•ˆç‡å‚æ•°
}

# è¯„ä¼°å‚æ•°
evaluation_params = {
    'k_values': [10],                  # Recall@Kçš„Kå€¼
    'n_probe_values': [5, 10, 20]     # æ¢æµ‹èšç±»æ•°é‡èŒƒå›´
}
```

### æ€§èƒ½çº¦æŸæ¡ä»¶å®šåˆ¶
```python
# å¯åœ¨ä»£ç ä¸­è‡ªå®šä¹‰çš„æ€§èƒ½çº¦æŸ
constraints = {
    'max_avg_query_time_ms': 50.0,     # æœ€å¤§å¹³å‡æŸ¥è¯¢æ—¶é—´
    'min_recall_at_k': 0.80,           # æœ€å°å¬å›ç‡è¦æ±‚
    'max_construction_time_s': 300.0   # æœ€å¤§æ„å»ºæ—¶é—´
}
```

## ğŸ“ è¾“å‡ºæ–‡ä»¶ç»“æ„è¯¦è§£

### method3_tuning_results.json (å®Œæ•´ç»“æœæ–‡ä»¶)
```json
{
  "evaluation_info": {
    "dataset_size": 50000,
    "query_size": 1000,
    "dimension": 128,
    "timestamp": "2025-09-22T10:30:00",
    "version": "optimized_component_reuse_v2.0"
  },
  
  "sweep_results": [                    // æ‰€æœ‰å‚æ•°ç»„åˆçš„è¯¦ç»†ç»“æœ
    {
      "parameters": {
        "n_clusters": 64,
        "k_children": 200,
        "child_search_ef": 300
      },
      "construction_time": 45.67,
      "phase_evaluations": [
        {
          "phase": "baseline_hnsw",
          "k": 10,
          "ef": 300,
          "recall_at_k": 0.9120,
          "avg_query_time_ms": 52.18,
          "component_reused": true
        },
        {
          "phase": "clusters_only", 
          "k": 10,
          "recall_at_k": 0.7340,
          "avg_query_time_ms": 8.95,
          "reused_existing_clustering": true,
          "clustering_time_saved": "100%"
        },
        {
          "phase": "kmeans_hnsw_hybrid",
          "k": 10,
          "n_probe": 10,
          "recall_at_k": 0.8750,
          "avg_query_time_ms": 15.23
        }
      ]
    }
  ],
  
  "optimal_parameters": {               // æœ€ä¼˜å‚æ•°é…ç½®
    "parameters": {
      "n_clusters": 64,
      "k_children": 200,
      "child_search_ef": 300
    },
    "performance": {
      "recall_at_k": 0.8750,
      "avg_query_time_ms": 15.23
    },
    "construction_time": 45.67
  },
  
  "baseline_comparison": {              // åŸºçº¿å¯¹æ¯”ç»“æœ 
    "kmeans_hnsw": {
      "recall_at_k": 0.8750,
      "avg_query_time_ms": 15.23
    },
    "pure_kmeans": {
      "recall_at_k": 0.7340,
      "avg_query_time_ms": 8.95,
      "reused_existing": true
    },
    "baseline_hnsw": [
      {
        "ef": 300,
        "recall_at_k": 0.9120,
        "avg_query_time_ms": 52.18,
        "reused_existing": true
      }
    ],
    "parameter_consistency": {          // å‚æ•°ä¸€è‡´æ€§éªŒè¯
      "kmeans_hnsw_n_clusters": 64,
      "pure_kmeans_n_clusters": 64,
      "kmeans_hnsw_child_search_ef": 300,
      "baseline_hnsw_ef": 300,
      "consistency_verified": true
    }
  },
  
  "adaptive_config": {                  // è‡ªé€‚åº”é…ç½®ä¿¡æ¯
    "adaptive_k_children": true,
    "k_children_scale": 2.0,
    "k_children_min": 100,
    "k_children_max": 800,
    "diversify_max_assignments": 10
  },
  
  "optimization_analysis": {            // ä¼˜åŒ–æ•ˆæœåˆ†æ
    "component_reuse_efficiency": {
      "hnsw_build_time_saved": "100%",
      "kmeans_training_time_saved": "100%",
      "total_evaluation_speedup": "85%"
    },
    "performance_tradeoffs": {
      "speed_vs_baseline_hnsw": "+65.4%",
      "recall_vs_baseline_hnsw": "-4.1%",
      "recall_vs_pure_kmeans": "+19.2%",
      "time_vs_pure_kmeans": "+70%"
    }
  }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µæŒ‡å—

### æ•°æ®é›†è§„æ¨¡ä¼˜åŒ–å»ºè®®

#### å°æ•°æ®é›† (<10Kå‘é‡)
```bash
# æ¨èé…ç½®
python tune_kmeans_hnsw.py \
    --dataset-size 5000 \
    --query-size 50

# å‚æ•°å»ºè®®:
# - n_clusters: 10-32
# - k_children: 100-200  
# - é€‚åˆ: å¿«é€ŸåŸå‹éªŒè¯
# - ç‰¹ç‚¹: æ„å»ºå¿«ï¼ŒéªŒè¯ç®—æ³•æ­£ç¡®æ€§
```

#### ä¸­ç­‰æ•°æ®é›† (10K-100Kå‘é‡)
```bash
# æ¨èé…ç½®
python tune_kmeans_hnsw.py \
    --dataset-size 50000 \
    --query-size 500 \
    --adaptive-k-children \
    --k-children-scale 1.8

# å‚æ•°å»ºè®®:
# - n_clusters: 32-128
# - k_children: 200-400
# - å¯ç”¨è‡ªé€‚åº”ä¼˜åŒ–
# - ç‰¹ç‚¹: å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦
```

#### å¤§æ•°æ®é›† (>100Kå‘é‡)
```bash
# æ¨èé…ç½®  
python tune_kmeans_hnsw.py \
    --dataset-size 500000 \
    --query-size 1000 \
    --adaptive-k-children \
    --k-children-scale 2.0 \
    --diversify-max-assignments 12 \
    --repair-min-assignments 3

# å‚æ•°å»ºè®®:
# - n_clusters: 128-512
# - k_children: 400-800
# - å¯ç”¨å¤šæ ·åŒ–å’Œä¿®å¤æœºåˆ¶
# - ç‰¹ç‚¹: å¤„ç†å¤§è§„æ¨¡æ•°æ®
```

### å†…å­˜ä¼˜åŒ–ç­–ç•¥

#### å†…å­˜çº¦æŸç¯å¢ƒ
1. **å¯ç”¨å¤šæ ·åŒ–åˆ†é…**: `--diversify-max-assignments 6-10`
2. **é™åˆ¶å­èŠ‚ç‚¹æ•°é‡**: `--k-children-max 500`
3. **ä½¿ç”¨MiniBatchç­–ç•¥**: è‡ªåŠ¨å¯ç”¨ï¼Œå‡å°‘èšç±»å†…å­˜
4. **ç»„ä»¶é‡ç”¨**: é¿å…é‡å¤å†…å­˜åˆ†é…ï¼Œæ•ˆç‡æå‡60%+

#### å†…å­˜ä½¿ç”¨ç›‘æ§
```bash
# åœ¨Windows PowerShellä¸­ç›‘æ§å†…å­˜ä½¿ç”¨
Get-Process python | Select-Object Name, CPU, WorkingSet

# æ¨èåœ¨å¤§æ•°æ®é›†æµ‹è¯•å‰æ£€æŸ¥å¯ç”¨å†…å­˜
Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory
```

### é€Ÿåº¦ä¼˜åŒ–æŠ€å·§

#### æŸ¥è¯¢é€Ÿåº¦ä¼˜åŒ–
1. **é€‚å½“çš„èšç±»æ•°**: è¿‡å¤šèšç±»å¢åŠ ç¬¬ä¸€é˜¶æ®µå¼€é”€
2. **åˆç†çš„å­èŠ‚ç‚¹æ•°**: å¹³è¡¡æ„å»ºæ—¶é—´å’Œæœç´¢è´¨é‡
3. **å¯ç”¨è‡ªé€‚åº”æœºåˆ¶**: æ ¹æ®æ•°æ®åˆ†å¸ƒè‡ªåŠ¨è°ƒæ•´
4. **ç»„ä»¶é‡ç”¨**: è¯„ä¼°é˜¶æ®µé€Ÿåº¦æå‡80%+

#### æ„å»ºé€Ÿåº¦ä¼˜åŒ–
1. **ä½¿ç”¨MiniBatchKMeans**: å¤§æ•°æ®é›†èšç±»åŠ é€Ÿ
2. **é€‚å½“çš„k_children**: é¿å…è¿‡åº¦å¤æ‚çš„HNSWç»“æ„
3. **å¯ç”¨ä¿®å¤æœºåˆ¶**: è™½ç„¶å¢åŠ æ„å»ºæ—¶é—´ï¼Œä½†æå‡é•¿æœŸæŸ¥è¯¢æ€§èƒ½

## ğŸ› æ•…éšœæ’é™¤å’Œå¸¸è§é—®é¢˜

### ç¯å¢ƒå’Œæ•°æ®é—®é¢˜

#### Q1: SIFTæ•°æ®åŠ è½½å¤±è´¥
```
Error loading SIFT data: FileNotFoundError: sift_base.fvecs not found
Using synthetic data instead...
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ³•1: ç¡®ä¿SIFTæ•°æ®æ–‡ä»¶å­˜åœ¨
# æ£€æŸ¥ sift/ ç›®å½•ä¸‹æ˜¯å¦æœ‰ä»¥ä¸‹æ–‡ä»¶:
# - sift_base.fvecs
# - sift_query.fvecs
# - sift_groundtruth.ivecs
# - sift_learn.fvecs

# æ–¹æ³•2: å¼ºåˆ¶ä½¿ç”¨åˆæˆæ•°æ®
python tune_kmeans_hnsw.py --no-sift --dataset-size 20000 --dimension 256
```

#### Q2: å†…å­˜ä¸è¶³é”™è¯¯
```
MemoryError: Unable to allocate array with shape (100000, 128)
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å‡å°‘æ•°æ®é›†å¤§å°
python tune_kmeans_hnsw.py --dataset-size 20000

# å¯ç”¨å†…å­˜ä¼˜åŒ–å‚æ•°
python tune_kmeans_hnsw.py \
    --dataset-size 50000 \
    --diversify-max-assignments 6 \
    --k-children-max 400

# æ£€æŸ¥ç³»ç»Ÿå¯ç”¨å†…å­˜(Windows)
Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object FreePhysicalMemory
```

### æ€§èƒ½å’Œé…ç½®é—®é¢˜

#### Q3: å‚æ•°è°ƒä¼˜æ—¶é—´è¿‡é•¿
```
Testing 27 parameter combinations...
Combination 1/27: {'n_clusters': 32, 'k_children': 200, 'child_search_ef': 300}
...
```

**è§£å†³æ–¹æ¡ˆ**:
- ç³»ç»Ÿè‡ªåŠ¨é™åˆ¶æœ€å¤§ç»„åˆæ•°é‡(`max_combos = 9`)
- å¯ä»¥é€šè¿‡å‡å°‘æ•°æ®é›†å¤§å°è¿›è¡Œå¿«é€ŸéªŒè¯:
```bash
python tune_kmeans_hnsw.py --dataset-size 5000 --query-size 20
```

#### Q4: ç»„ä»¶é‡ç”¨éªŒè¯å¤±è´¥
```
âŒ å‚æ•°ä¸€è‡´æ€§æ£€æŸ¥: Pure K-Meansä½¿ç”¨äº†ä¸åŒçš„èšç±»å‚æ•°
```

**æ£€æŸ¥æ–¹æ³•**:
1. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¸­çš„å‚æ•°ä¸€è‡´æ€§éªŒè¯
2. æ£€æŸ¥JSONç»“æœæ–‡ä»¶ä¸­çš„`parameter_consistency`éƒ¨åˆ†
3. æ­£å¸¸æƒ…å†µåº”è¯¥çœ‹åˆ°:
   ```
   âœ… KMeansHNSWå®é™…å‚æ•°: n_clusters=64, child_search_ef=300
   âœ… åŸºçº¿HNSWä½¿ç”¨ç›¸åŒefå‚æ•°: 300 (é‡ç”¨base_index)
   âœ… çº¯K-Meansä½¿ç”¨ç›¸åŒèšç±»: n_clusters=64 (é‡ç”¨èšç±»ç»“æœ)
   ```

#### Q5: å¬å›ç‡å¼‚å¸¸ä½
```
K-Means HNSWæ··åˆ: Recall=0.234, Time=15.23ms
```

**è¯Šæ–­å’Œè§£å†³**:
```bash
# é¦–å…ˆç”¨å°æ•°æ®é›†éªŒè¯ç®—æ³•æ­£ç¡®æ€§
python tune_kmeans_hnsw.py --dataset-size 2000 --query-size 10 --no-sift

# æ£€æŸ¥å‚æ•°æ˜¯å¦åˆç†:
# - n_probeè¿‡å°(å¢åŠ æ¢æµ‹èšç±»æ•°)
# - child_search_efè¿‡å°(å¢åŠ HNSWæœç´¢æ·±åº¦)
# - èšç±»æ•°è¿‡å¤š(å‡å°‘èšç±»æ•°é‡)

# å°è¯•æ›´ä¿å®ˆçš„å‚æ•°
python tune_kmeans_hnsw.py \
    --dataset-size 10000 \
    --adaptive-k-children \
    --k-children-scale 1.2 \
    --k-children-min 150
```

### é«˜çº§è°ƒè¯•æŠ€å·§

#### è°ƒè¯•æ¨¡å¼è¿è¡Œ
```bash
# å°æ•°æ®é›†è¯¦ç»†è°ƒè¯•
python tune_kmeans_hnsw.py \
    --dataset-size 1000 \
    --query-size 5 \
    --no-sift

# æ£€æŸ¥è¾“å‡ºä¸­çš„è¯¦ç»†ä¿¡æ¯:
# - æ¯ä¸ªé˜¶æ®µçš„å…·ä½“æ•°å€¼
# - ç»„ä»¶é‡ç”¨çŠ¶æ€
# - å‚æ•°ä¸€è‡´æ€§éªŒè¯
# - æ—¶é—´åˆ†è§£åˆ†æ
```

#### ç»“æœæ–‡ä»¶åˆ†æ
```bash
# æ£€æŸ¥å®Œæ•´ç»“æœæ–‡ä»¶
Get-Content method3_tuning_results.json | ConvertFrom-Json | ConvertTo-Json -Depth 10

# é‡ç‚¹æ£€æŸ¥éƒ¨åˆ†:
# - sweep_results: æ¯ä¸ªå‚æ•°ç»„åˆçš„è¯¦ç»†ç»“æœ
# - baseline_comparison: åŸºçº¿å¯¹æ¯”ç»“æœ  
# - parameter_consistency: å‚æ•°ä¸€è‡´æ€§éªŒè¯
# - optimization_analysis: ä¼˜åŒ–æ•ˆæœåˆ†æ
```

## ğŸ“š ç›¸å…³æŠ€æœ¯èµ„æ–™

### æ ¸å¿ƒç®—æ³•æ–‡æ¡£
- [HNSWç®—æ³•åŸç†è¯¦è§£](../docs/HNSWç®—æ³•åŸç†è¯¦è§£.md)
- [K-Means HNSWæ··åˆæ¶æ„](../docs/HNSW_Hybrid_Technical_Implementation.md)
- [ç®—æ³•åŸç†è‹±æ–‡ç‰ˆ](../docs/HNSW_Hybrid_Algorithm_Principles.md)

### ä»£ç å®ç°å‚è€ƒ
- [method3/kmeans_hnsw.py](./kmeans_hnsw.py) - æ ¸å¿ƒæ··åˆæœç´¢ç³»ç»Ÿ
- [hnsw/hnsw.py](../hnsw/hnsw.py) - HNSWåŸºç¡€å®ç°
- [method3/tune_kmeans_hnsw.py](./tune_kmeans_hnsw.py) - æœ¬è°ƒä¼˜å·¥å…·

### å¤–éƒ¨å‚è€ƒèµ„æ–™
- [HNSWåŸå§‹è®ºæ–‡](https://arxiv.org/abs/1603.09320) - Malkov & Yashunin (2018)
- [K-Meansèšç±»ç®—æ³•](https://scikit-learn.org/stable/modules/clustering.html#k-means) - Scikit-learnæ–‡æ¡£
- [SIFTç‰¹å¾æè¿°ç¬¦](https://en.wikipedia.org/wiki/Scale-invariant_feature_transform) - æ ‡å‡†æµ‹è¯•æ•°æ®é›†
- [å‘é‡ç›¸ä¼¼æ€§æœç´¢ç»¼è¿°](https://arxiv.org/abs/2003.11154) - æœ€æ–°ç ”ç©¶è¿›å±•

### æ€§èƒ½åŸºå‡†å‚è€ƒ
- SIFT-1Mæ•°æ®é›†æ ‡å‡†åŸºå‡†æµ‹è¯•ç»“æœ
- ANN-Benchmarksé¡¹ç›®å¯¹æ¯”æ•°æ®
- ä¸åŒè§„æ¨¡æ•°æ®é›†çš„æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”
- å†…å­˜ä½¿ç”¨å’ŒæŸ¥è¯¢æ—¶é—´çš„æƒè¡¡åˆ†æ

## ğŸ“ˆ ç‰ˆæœ¬å†å²å’Œæ›´æ–°æ—¥å¿—

### v2.0 (å½“å‰ç‰ˆæœ¬) - ç»„ä»¶é‡ç”¨ä¼˜åŒ–ç‰ˆ
- âœ… **çªç ´æ€§ä¼˜åŒ–**: å®ç°å®Œå…¨çš„ç»„ä»¶é‡ç”¨æ¶æ„
- âœ… **å‚æ•°ä¸€è‡´æ€§**: ç¡®ä¿æ‰€æœ‰è¯„ä¼°é˜¶æ®µä½¿ç”¨ç›¸åŒå‚æ•°
- âœ… **æ€§èƒ½æå‡**: è¯„ä¼°é€Ÿåº¦æå‡80%ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘60%
- âœ… **ä»£ç é‡æ„**: æ¶ˆé™¤é‡å¤ä»£ç ï¼Œä¿®å¤ç´¢å¼•æ˜ å°„bug
- âœ… **æ–‡æ¡£æ›´æ–°**: å…¨é¢æ›´æ–°ä½¿ç”¨æŒ‡å—å’ŒæŠ€æœ¯æ–‡æ¡£

### v1.5 - ä»£ç ä¼˜åŒ–ç‰ˆ
- ä¿®å¤K-Meansè¯„ä¼°ä¸­çš„ç´¢å¼•æ˜ å°„é—®é¢˜
- ä¼˜åŒ–å‚æ•°æ‰«æé€»è¾‘ï¼Œå‡å°‘é‡å¤è®¡ç®—
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯

### v1.0 - åˆå§‹ç‰ˆæœ¬
- åŸºç¡€å‚æ•°è°ƒä¼˜åŠŸèƒ½
- ä¸‰é˜¶æ®µè¯„ä¼°ä½“ç³»
- SIFTæ•°æ®é›†æ”¯æŒ
- åŸºæœ¬æ€§èƒ½åˆ†æ

---

**å½“å‰ç‰ˆæœ¬**: v2.0 (ç»„ä»¶é‡ç”¨ä¼˜åŒ–ç‰ˆ)  
**æœ€åæ›´æ–°**: 2025å¹´9æœˆ22æ—¥  
**ä»£ç çŠ¶æ€**: å®Œå…¨ä¼˜åŒ–ï¼Œç”Ÿäº§å°±ç»ª  
**ç»´æŠ¤å›¢é˜Ÿ**: datasketch-enhancedå¼€å‘å›¢é˜Ÿ

**ä½¿ç”¨å»ºè®®**: å»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§åˆ°v2.0ç‰ˆæœ¬ï¼Œäº«å—ç»„ä»¶é‡ç”¨å¸¦æ¥çš„æ˜¾è‘—æ€§èƒ½æå‡å’Œæ›´å‡†ç¡®çš„è¯„ä¼°ç»“æœã€‚
