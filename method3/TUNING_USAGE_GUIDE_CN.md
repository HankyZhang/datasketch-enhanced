# K-Means HNSWå‚æ•°è°ƒä¼˜å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“š æ¦‚è¿°

`tune_kmeans_hnsw.py` æ˜¯ä¸€ä¸ªå…¨é¢çš„å‚æ•°è°ƒä¼˜å’Œè¯„ä¼°å·¥å…·ï¼Œç”¨äºä¼˜åŒ–K-Means HNSW(å±‚æ¬¡åŒ–å¯å¯¼èˆªå°ä¸–ç•Œå›¾)æ··åˆæœç´¢ç³»ç»Ÿçš„æ€§èƒ½ã€‚è¯¥å·¥å…·æä¾›ç³»ç»Ÿæ€§çš„å‚æ•°æ‰«æã€æ€§èƒ½è¯„ä¼°å’ŒåŸºå‡†å¯¹æ¯”åŠŸèƒ½ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. ç®—æ³•å¯¹æ¯”è¯„ä¼°
- **åŸºçº¿HNSW**: åŸå§‹HNSWç®—æ³•æ€§èƒ½åŸºå‡†
- **çº¯K-Meansèšç±»**: MiniBatchKMeansèšç±»æœç´¢
- **K-Means HNSWæ··åˆ**: ä¸¤é˜¶æ®µæ··åˆæœç´¢ç³»ç»Ÿ

### 2. å‚æ•°è‡ªåŠ¨è°ƒä¼˜
- èšç±»æ•°é‡(n_clusters)ä¼˜åŒ–
- å­èŠ‚ç‚¹æ•°é‡(k_children)è°ƒæ•´
- æœç´¢æ•ˆç‡å‚æ•°(child_search_ef)ä¼˜åŒ–
- æ¢æµ‹èšç±»æ•°(n_probe)é…ç½®

### 3. æ€§èƒ½æŒ‡æ ‡åˆ†æ
- **å¬å›ç‡(Recall@K)**: ç®—æ³•å‡†ç¡®æ€§è¯„ä¼°
- **æŸ¥è¯¢æ—¶é—´**: å¹³å‡æŸ¥è¯¢å»¶è¿Ÿåˆ†æ
- **æ„å»ºæ—¶é—´**: ç´¢å¼•æ„å»ºè€—æ—¶ç»Ÿè®¡
- **å†…å­˜ä½¿ç”¨**: ç³»ç»Ÿèµ„æºæ¶ˆè€—ç›‘æ§

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨
```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°è¿è¡Œ(10Kæ•°æ®é›†ï¼Œ50ä¸ªæŸ¥è¯¢)
python tune_kmeans_hnsw.py

# ä½¿ç”¨SIFTæ•°æ®é›†
python tune_kmeans_hnsw.py --dataset-size 50000 --query-size 1000

# å¼ºåˆ¶ä½¿ç”¨åˆæˆæ•°æ®
python tune_kmeans_hnsw.py --no-sift --dataset-size 20000 --dimension 256
```

### é«˜çº§é…ç½®
```bash
# å¯ç”¨è‡ªé€‚åº”å‚æ•°è°ƒæ•´
python tune_kmeans_hnsw.py \
    --adaptive-k-children \
    --k-children-scale 2.0 \
    --k-children-min 150 \
    --k-children-max 500

# å¯ç”¨å¤šæ ·åŒ–åˆ†é…å’Œä¿®å¤æœºåˆ¶
python tune_kmeans_hnsw.py \
    --diversify-max-assignments 10 \
    --repair-min-assignments 3 \
    --manual-repair \
    --manual-repair-min 2
```

## ğŸ“Š å‚æ•°è¯¦è§£

### æ•°æ®é›†å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--dataset-size` | 10000 | åŸºç¡€å‘é‡æ•°é‡ï¼Œå½±å“æœç´¢å‡†ç¡®æ€§å’Œæ„å»ºæ—¶é—´ |
| `--query-size` | 50 | æŸ¥è¯¢å‘é‡æ•°é‡ï¼Œç”¨äºæ€§èƒ½è¯„ä¼° |
| `--dimension` | 128 | å‘é‡ç»´åº¦(ä»…ç”¨äºåˆæˆæ•°æ®) |
| `--no-sift` | False | å¼ºåˆ¶ä½¿ç”¨åˆæˆæ•°æ®è€ŒéSIFTæ•°æ®é›† |

### è‡ªé€‚åº”å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--adaptive-k-children` | False | å¯ç”¨åŸºäºå¹³å‡èšç±»å¤§å°çš„è‡ªé€‚åº”å­èŠ‚ç‚¹æ•° |
| `--k-children-scale` | 1.5 | è‡ªé€‚åº”ç¼©æ”¾å› å­ï¼Œå½±å“å­èŠ‚ç‚¹æ•°é‡è®¡ç®— |
| `--k-children-min` | 100 | è‡ªé€‚åº”æ¨¡å¼ä¸‹çš„æœ€å°å­èŠ‚ç‚¹æ•° |
| `--k-children-max` | None | è‡ªé€‚åº”æ¨¡å¼ä¸‹çš„æœ€å¤§å­èŠ‚ç‚¹æ•°(å¯é€‰) |

### ä¼˜åŒ–ç­–ç•¥å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--diversify-max-assignments` | None | æ¯ä¸ªå­èŠ‚ç‚¹çš„æœ€å¤§åˆ†é…æ•°ï¼Œå¯ç”¨å¤šæ ·åŒ–ç­–ç•¥ |
| `--repair-min-assignments` | None | æ„å»ºæœŸé—´çš„æœ€å°åˆ†é…æ•°ï¼Œå¯ç”¨ä¿®å¤æœºåˆ¶ |
| `--manual-repair` | False | åœ¨æœ€ä¼˜æ„å»ºåæ‰§è¡Œæ‰‹åŠ¨ä¿®å¤ |
| `--manual-repair-min` | None | æ‰‹åŠ¨ä¿®å¤çš„æœ€å°åˆ†é…é˜ˆå€¼ |

## ğŸ”¬ æ ¸å¿ƒç®—æ³•åŸç†

### K-Means HNSWæ··åˆæœç´¢
1. **ç¬¬ä¸€é˜¶æ®µ**: ä½¿ç”¨K-Meansèšç±»å¿«é€Ÿå®šä½å€™é€‰åŒºåŸŸ
2. **ç¬¬äºŒé˜¶æ®µ**: åœ¨é€‰å®šèšç±»å†…ä½¿ç”¨HNSWè¿›è¡Œç²¾ç¡®æœç´¢
3. **ä¼˜åŠ¿**: ç»“åˆäº†èšç±»çš„ç²—ç²’åº¦è¿‡æ»¤å’ŒHNSWçš„é«˜ç²¾åº¦æœç´¢

### å‚æ•°è°ƒä¼˜ç­–ç•¥
```python
# è‡ªåŠ¨å‚æ•°ç½‘æ ¼å®šä¹‰
param_grid = {
    'n_clusters': [32, 64, 128],      # èšç±»æ•°é‡é€‰æ‹©
    'k_children': [200, 400],         # å­èŠ‚ç‚¹æ•°é‡
    'child_search_ef': [300, 500]     # æœç´¢æ•ˆç‡å‚æ•°
}

evaluation_params = {
    'k_values': [10],                 # è¯„ä¼°Kå€¼
    'n_probe_values': [5, 10, 20]     # æ¢æµ‹èšç±»æ•°
}
```

## ğŸ“ˆ è¾“å‡ºç»“æœè§£è¯»

### æ€§èƒ½æŒ‡æ ‡
```
ğŸ¯ ç®—æ³•å¯¹æ¯”ç»“æœ:
K-Means HNSW: Recall=0.8500, Time=12.34ms
Pure K-Means: Recall=0.7200, Time=8.76ms  
Best Baseline: Recall=0.9100, Time=45.67ms
```

- **Recall**: å¬å›ç‡ï¼Œå€¼è¶Šé«˜è¡¨ç¤ºæ‰¾åˆ°çš„çœŸå®é‚»å±…è¶Šå¤š
- **Time**: å¹³å‡æŸ¥è¯¢æ—¶é—´ï¼Œå€¼è¶Šä½è¡¨ç¤ºæœç´¢é€Ÿåº¦è¶Šå¿«
- **æƒè¡¡**: é€šå¸¸å¬å›ç‡å’Œé€Ÿåº¦ä¹‹é—´éœ€è¦æƒè¡¡

### è¯¦ç»†åˆ†æè¾“å‡º
```
ğŸ“Š è¯¦ç»†çº¯K-Meansç»“æœ:
  Overall Recall@10: 0.7200
  Average Individual Recall: 0.7150
  Correct/Expected: 360/500
  Clustering Time: 2.45s
  Average Query Time: 8.76ms
```

## ğŸ› ï¸ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å¿«é€ŸåŸå‹éªŒè¯
```bash
# å°è§„æ¨¡å¿«é€Ÿæµ‹è¯•
python tune_kmeans_hnsw.py --dataset-size 5000 --query-size 20
```

### åœºæ™¯2: ç”Ÿäº§ç¯å¢ƒè°ƒä¼˜
```bash
# å¤§è§„æ¨¡æ€§èƒ½ä¼˜åŒ–
python tune_kmeans_hnsw.py \
    --dataset-size 100000 \
    --query-size 500 \
    --adaptive-k-children \
    --diversify-max-assignments 8
```

### åœºæ™¯3: ç®—æ³•ç ”ç©¶åˆ†æ
```bash
# è¯¦ç»†æ€§èƒ½åˆ†æ
python tune_kmeans_hnsw.py \
    --no-sift \
    --dimension 512 \
    --manual-repair \
    --repair-min-assignments 5
```

## ğŸ“ è¾“å‡ºæ–‡ä»¶

### method3_tuning_results.json
è°ƒä¼˜å®Œæˆåï¼Œç»“æœä¼šä¿å­˜åˆ°JSONæ–‡ä»¶ä¸­ï¼ŒåŒ…å«ï¼š
- `sweep_results`: æ‰€æœ‰å‚æ•°ç»„åˆçš„è¯¦ç»†ç»“æœ
- `optimal_parameters`: æœ€ä¼˜å‚æ•°é…ç½®
- `baseline_comparison`: ä¸åŸºçº¿ç®—æ³•çš„å¯¹æ¯”
- `evaluation_info`: è¯„ä¼°ç¯å¢ƒä¿¡æ¯

## ğŸ”§ è‡ªå®šä¹‰æ‰©å±•

### æ·»åŠ æ–°çš„å‚æ•°
```python
# åœ¨param_gridä¸­æ·»åŠ æ–°å‚æ•°
param_grid = {
    'n_clusters': [16, 32, 64],
    'k_children': [100, 200, 400],
    'child_search_ef': [200, 300, 500],
    'custom_param': [1, 2, 3]  # æ–°å‚æ•°
}
```

### è‡ªå®šä¹‰è¯„ä¼°æŒ‡æ ‡
```python
# æ·»åŠ æ–°çš„æ€§èƒ½çº¦æŸ
constraints = {
    'avg_query_time_ms': 50.0,    # æœ€å¤§æŸ¥è¯¢æ—¶é—´
    'recall_at_k': 0.8            # æœ€å°å¬å›ç‡
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æ•°æ®é›†å¤§å°é€‰æ‹©
- **å°æ•°æ®é›†(<10K)**: ä½¿ç”¨è¾ƒå°‘èšç±»æ•°(10-32)
- **ä¸­ç­‰æ•°æ®é›†(10K-100K)**: ä½¿ç”¨é€‚ä¸­èšç±»æ•°(32-128)  
- **å¤§æ•°æ®é›†(>100K)**: ä½¿ç”¨æ›´å¤šèšç±»æ•°(128-512)

### å‚æ•°è°ƒä¼˜ç­–ç•¥
1. **å…ˆç²—è°ƒåç»†è°ƒ**: å…ˆç”¨å¤§æ­¥é•¿æ‰¾åˆ°å¤§è‡´èŒƒå›´ï¼Œå†ç»†åŒ–
2. **æƒè¡¡å¬å›ç‡å’Œé€Ÿåº¦**: æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´å‚æ•°ä¼˜å…ˆçº§
3. **ä½¿ç”¨è‡ªé€‚åº”å‚æ•°**: å¯¹äºå˜åŒ–çš„æ•°æ®åˆ†å¸ƒï¼Œå¯ç”¨è‡ªé€‚åº”æœºåˆ¶

### å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨MiniBatchKMeanså‡å°‘å†…å­˜å ç”¨
- é™åˆ¶k_childrenæ•°é‡é¿å…å†…å­˜çˆ†ç‚¸
- å¯ç”¨å¤šæ ·åŒ–åˆ†é…æœºåˆ¶æé«˜å†…å­˜æ•ˆç‡

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: SIFTæ•°æ®åŠ è½½å¤±è´¥**
```
Error loading SIFT data: FileNotFoundError
Using synthetic data instead...
```
A: ç¡®ä¿siftç›®å½•ä¸‹æœ‰æ­£ç¡®çš„.fvecsæ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨`--no-sift`å¼ºåˆ¶ä½¿ç”¨åˆæˆæ•°æ®

**Q: å†…å­˜ä¸è¶³é”™è¯¯**
```
MemoryError: Unable to allocate array
```
A: å‡å°‘`--dataset-size`æˆ–å¯ç”¨`--diversify-max-assignments`é™åˆ¶å†…å­˜ä½¿ç”¨

**Q: å‚æ•°è°ƒä¼˜æ—¶é—´è¿‡é•¿**
```
Testing 27 parameter combinations...
```
A: å‡å°‘å‚æ•°ç½‘æ ¼å¤§å°æˆ–è®¾ç½®è¾ƒå°çš„`max_combinations`

### è°ƒè¯•æŠ€å·§
1. ä½¿ç”¨å°æ•°æ®é›†å¿«é€ŸéªŒè¯å‚æ•°
2. æ£€æŸ¥JSONè¾“å‡ºæ–‡ä»¶ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºè§‚å¯Ÿè°ƒä¼˜è¿‡ç¨‹

## ğŸ“š ç›¸å…³èµ„æ–™

- [HNSWç®—æ³•åŸç†](../docs/HNSWç®—æ³•åŸç†è¯¦è§£.md)
- [K-Meansèšç±»ç†è®º](https://scikit-learn.org/stable/modules/clustering.html#k-means)
- [SIFTç‰¹å¾æè¿°ç¬¦](https://en.wikipedia.org/wiki/Scale-invariant_feature_transform)
- [å‘é‡ç›¸ä¼¼æ€§æœç´¢ç»¼è¿°](https://arxiv.org/abs/1603.09320)

---

**æœ€åæ›´æ–°**: 2025å¹´9æœˆ
**ç‰ˆæœ¬**: 1.0
**ä½œè€…**: datasketch-enhancedå›¢é˜Ÿ
